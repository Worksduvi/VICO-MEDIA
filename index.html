<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VICO MEDIA</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root { --bg-color: #050505; --card-bg: #111; --primary: #00fff7; --secondary: #ff00ff; --text: #fff; }
        body.matrix-mode { --bg-color: #000; --card-bg: #0a140a; --primary: #00ff00; --secondary: #008f11; --text: #e0ffe0; }

        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text); padding-bottom: 90px; overflow-x: hidden; transition: 0.3s; }
        h1, h2, h3, button, select { font-family: 'Orbitron', sans-serif; }
        .hidden { display: none !important; }

        /* Header & Nav */
        header { padding: 15px; background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%); border-bottom: 1px solid var(--primary); position: sticky; top: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(10px); }
        .logo-text { font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px var(--primary); }
        .logo-accent { color: var(--secondary); }
        .lang-select { background: #111; color: var(--primary); border: 1px solid var(--primary); padding: 5px; border-radius: 4px; font-size: 0.7rem; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(8,8,8,0.95); border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; backdrop-filter: blur(5px); }
        .nav-btn { background: none; border: none; color: #666; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; gap: 4px; }
        .nav-btn.active { color: var(--primary); text-shadow: 0 0 5px var(--primary); }
        
        main { padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* Buttons & Inputs */
        .action-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-neon { flex: 1; padding: 12px; background: transparent; border: 1px solid var(--primary); color: var(--primary); box-shadow: 0 0 5px var(--primary); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.8rem; border-radius: 4px; }
        .btn-neon:active { background: var(--primary); color: black; }
        .btn-neon.alt { border-color: var(--secondary); color: var(--secondary); box-shadow: 0 0 5px var(--secondary); }
        .btn-neon.alt:active { background: var(--secondary); color: black; }
        
        .input-box { background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px; }
        input, textarea, select { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border-radius: 4px; }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .card { background: var(--card-bg); border-radius: 8px; overflow: hidden; position: relative; border: 1px solid #333; transition: 0.2s; }
        .card img { width: 100%; height: 200px; object-fit: cover; background: #222; display: block; }
        .card-info { padding: 10px; }
        .card-title { font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text); }
        
        .card-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 10; flex-direction: column; }
        .mini-btn { background: rgba(0,0,0,0.8); color: white; border: 1px solid #333; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;}
        .mini-btn:active { transform: scale(0.9); }
        .mini-btn.fav.active { color: var(--secondary); border-color: var(--secondary); }
        
        /* Double Play Buttons */
        .play-actions { position: absolute; bottom: 40px; left: 0; width: 100%; display: flex; justify-content: space-around; padding: 10px; background: linear-gradient(0deg, rgba(0,0,0,0.9), transparent); opacity: 0; transition: 0.2s; }
        .card:hover .play-actions { opacity: 1; }
        .play-btn { background: var(--primary); color: black; border: none; padding: 8px 12px; border-radius: 20px; font-weight: bold; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .web-btn { background: #333; color: white; border: 1px solid #555; padding: 8px 12px; border-radius: 20px; font-weight: bold; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* Discovery Section */
        .discovery-header { border-left: 4px solid var(--secondary); padding-left: 10px; margin: 20px 0 10px; }
        .video-scroll { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; }
        .trailer-card { min-width: 200px; background: #111; border-radius: 8px; overflow: hidden; border: 1px solid #333; position: relative; }
        .trailer-card img { width: 100%; height: 115px; object-fit: cover; }
        .trailer-overlay { position: absolute; top:0; left:0; width:100%; height:115px; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; }

        /* Modal Player */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; display: flex; flex-direction: column; }
        .modal-header { padding: 10px; background: #111; border-bottom: 1px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .video-container { flex: 1; background: black; display: flex; align-items: center; justify-content: center; position: relative; }
        iframe, video { width: 100%; height: 100%; border: none; }
        .ad-block-warning { position: absolute; bottom: 10px; background: rgba(255,0,0,0.8); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; pointer-events: none; }

        /* Chat */
        .chat-window { height: 350px; background: var(--card-bg); border: 1px solid #333; margin-bottom: 10px; padding: 10px; overflow-y: auto; border-radius: 8px; }
        .chat-msg { margin-bottom: 8px; padding: 8px; border-radius: 6px; font-size: 0.9rem; max-width: 85%; word-wrap: break-word; }
        .msg-user { background: #333; margin-left: auto; color: white; border-left: 2px solid #555; }
        .msg-ai { background: rgba(0, 255, 247, 0.1); border: 1px solid var(--primary); color: var(--text); border-left: 4px solid var(--primary); }
        .msg-error { background: rgba(255, 0, 0, 0.1); border: 1px solid red; color: #ff6b6b; font-size: 0.8rem;}

        /* Credits & Donate */
        .credits-box { text-align: center; margin-top: 20px; padding: 20px; border-top: 1px solid #333; }
        .paypal-btn { background: #0070ba; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: bold; cursor: pointer; display: inline-flex; gap: 8px; align-items: center; margin-top: 10px; text-decoration: none; }
        .link-ln { color: #0a66c2; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <div class="logo-text">VICO <span class="logo-accent">MEDIA</span></div>
        <select id="langSelect" class="lang-select" onchange="changeLanguage(this.value)">
            <option value="es">üá™üá∏ ES</option>
            <option value="en">üá∫üá∏ EN</option>
            <option value="zh">üá®üá≥ ZH</option>
        </select>
    </header>

    <main>
        
        <section id="view-library">
            <div class="action-bar">
                <button onclick="openEditMode()" class="btn-neon"><i data-lucide="plus"></i> <span data-t="btn_add">A√±adir</span></button>
                <button onclick="toggleInput('input-list')" class="btn-neon alt"><i data-lucide="list"></i> <span data-t="btn_import">Importar</span></button>
            </div>

            <div id="input-manual" class="input-box hidden">
                <h3 id="formTitle">A√±adir Video</h3>
                <input type="hidden" id="editIndex" value="-1">
                <input type="text" id="mTitle" placeholder="T√≠tulo">
                <input type="text" id="mUrl" placeholder="URL del video o web">
                <input type="text" id="mCover" placeholder="Imagen URL (Opcional)">
                <div style="display:flex; gap:10px">
                    <button onclick="saveMedia()" class="btn-neon" id="saveBtn">Guardar</button>
                    <button onclick="toggleInput('input-manual')" class="btn-neon danger">Cancelar</button>
                </div>
            </div>

            <div id="input-list" class="input-box hidden">
                <h3 data-t="title_import">Pegar Lista (M3U)</h3>
                <textarea id="mList" rows="5" placeholder="#EXTINF:-1, Titulo..."></textarea>
                <button onclick="importList()" class="btn-neon alt" style="width:100%">Procesar</button>
            </div>

            <div id="library-grid" class="grid"></div>
        </section>

        <section id="view-discovery" class="hidden">
            <h2 style="color:var(--secondary)" data-t="nav_discovery">Discovery</h2>
            <p style="font-size:0.8rem; color:#888;">Nuevos tr√°ilers cada d√≠a. Reproducci√≥n externa garantizada.</p>
            
            <div class="discovery-header"><h3 data-t="cat_action">Acci√≥n & Adrenalina</h3></div>
            <div class="video-scroll" id="feed-action"></div>

            <div class="discovery-header"><h3 data-t="cat_scifi">Sci-Fi & Futuro</h3></div>
            <div class="video-scroll" id="feed-scifi"></div>

            <div class="discovery-header"><h3 data-t="cat_real">Historias Reales</h3></div>
            <div class="video-scroll" id="feed-real"></div>
        </section>

        <section id="view-favorites" class="hidden">
            <h2 style="color:var(--secondary)"><i data-lucide="heart"></i> <span data-t="nav_favs">Favoritos</span></h2>
            
            <h3 style="margin-top:20px; font-size:1rem; border-bottom:1px solid #333; padding-bottom:5px;">Mis Videos</h3>
            <div id="fav-grid" class="grid"></div>

            <h3 style="margin-top:20px; font-size:1rem; border-bottom:1px solid #333; padding-bottom:5px;">Tr√°ilers Guardados</h3>
            <div id="fav-trailers-grid" class="grid"></div>
        </section>

        <section id="view-chat" class="hidden">
            <h2 data-t="nav_chat">Chat Ag√©ntico</h2>
            
            <div class="input-box" id="api-box">
                <label style="font-size:0.8rem; color:var(--primary)">Groq API Key:</label>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="password" id="apiKey" placeholder="gsk_..." style="margin:0">
                    <button onclick="saveApiKey()" class="btn-neon">Guardar</button>
                </div>
            </div>

            <div id="chatBox" class="chat-window">
                <div class="chat-msg msg-ai">VICO: <span data-t="chat_welcome">Hola. Soy tu asistente multimedia inteligente. Preg√∫ntame sobre cualquier pel√≠cula.</span></div>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="chatInput" placeholder="Ej: ¬øCu√°ndo se rod√≥ Titanic?" style="margin:0">
                <button onclick="sendChat()" class="btn-neon"><i data-lucide="send"></i></button>
            </div>
        </section>

        <section id="view-settings" class="hidden">
            <h2 data-t="nav_settings">Configuraci√≥n</h2>
            
            <div class="input-box">
                <h3 data-t="theme_title">Apariencia</h3>
                <button onclick="toggleTheme()" class="btn-neon alt" style="width:100%">
                    <i data-lucide="sun"></i> <span id="themeLabel">Modo Matrix</span>
                </button>
            </div>

            <div class="input-box">
                <h3 data-t="data_title">Datos</h3>
                <button onclick="exportData()" class="btn-neon" style="width:100%; margin-bottom:10px;"><i data-lucide="download"></i> Exportar JSON</button>
                <div style="position:relative">
                    <button class="btn-neon alt" style="width:100%"><i data-lucide="upload"></i> Restaurar JSON</button>
                    <input type="file" onchange="importData(this)" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                </div>
            </div>

            <div class="credits-box">
                <a href="https://www.paypal.com/paypalme/texiduvi" target="_blank" class="paypal-btn">
                    <i data-lucide="coffee"></i> <span data-t="donate_btn">Inv√≠tame un Caf√©</span>
                </a>
                
                <div style="margin-top: 25px; font-size: 0.8rem; color: #888; line-height: 1.6;">
                    &copy; 2026 VICO MEDIA App. Todos los derechos reservados.<br>
                    Creado por <a href="https://www.linkedin.com/in/jaime-andr√©s-due√±as-vicu√±a" target="_blank" class="link-ln"><i data-lucide="linkedin" size="14"></i> Jaime Andr√©s Due√±as Vicu√±a</a>
                </div>
            </div>
        </section>

    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('view-library', this)"><i data-lucide="film"></i> <span data-t="nav_lib">Biblio</span></button>
        <button class="nav-btn" onclick="switchTab('view-discovery', this)"><i data-lucide="compass"></i> <span data-t="nav_discovery">Discovery</span></button>
        <button class="nav-btn" onclick="switchTab('view-favorites', this)"><i data-lucide="heart"></i> <span data-t="nav_favs">Favs</span></button>
        <button class="nav-btn" onclick="switchTab('view-chat', this)"><i data-lucide="bot"></i> <span data-t="nav_chat">Chat</span></button>
        <button class="nav-btn" onclick="switchTab('view-settings', this)"><i data-lucide="settings"></i> <span data-t="nav_settings">Ajustes</span></button>
    </nav>

    <div id="playerModal" class="modal hidden">
        <div class="modal-header">
            <span id="playerTitle" style="font-weight:bold; color:var(--primary); overflow:hidden; white-space:nowrap; max-width:80%;">Reproductor</span>
            <button onclick="closePlayer()" style="background:none; border:none; color:red; font-size:1.5rem;"><i data-lucide="x"></i></button>
        </div>
        <div id="videoWrapper" class="video-container"></div>
    </div>

    <script>
        // --- ESTADO ---
        let library = JSON.parse(localStorage.getItem('vicomedia_lib')) || [];
        let trailerFavs = JSON.parse(localStorage.getItem('vicomedia_tfavs')) || [];
        let apiKey = localStorage.getItem('vicomedia_apikey') || '';
        let currentLang = localStorage.getItem('vicomedia_lang') || 'es';
        
        const TRANSLATIONS = {
            es: { nav_lib:"Biblio", nav_discovery:"Discovery", nav_favs:"Favs", nav_chat:"Chat", nav_settings:"Ajustes", btn_add:"A√±adir", btn_import:"Importar", title_import:"Pegar Lista M3U", cat_action:"Acci√≥n & Adrenalina", cat_scifi:"Sci-Fi & Futuro", cat_real:"Historias Reales", chat_welcome:"Hola. Soy tu asistente multimedia inteligente. Preg√∫ntame sobre pel√≠culas.", theme_title:"Apariencia", data_title:"Datos", donate_btn:"Inv√≠tame un Caf√©" },
            en: { nav_lib:"Library", nav_discovery:"Discovery", nav_favs:"Favs", nav_chat:"Chat", nav_settings:"Settings", btn_add:"Add", btn_import:"Import", title_import:"Paste M3U", cat_action:"Action & Adrenaline", cat_scifi:"Sci-Fi & Future", cat_real:"True Stories", chat_welcome:"Hello. I'm your smart media assistant. Ask me anything.", theme_title:"Appearance", data_title:"Data", donate_btn:"Buy me a Coffee" },
            zh: { nav_lib:"ËµÑÊñôÂ∫ì", nav_discovery:"ÂèëÁé∞", nav_favs:"Êî∂Ëóè", nav_chat:"ÂØπËØù", nav_settings:"ËÆæÁΩÆ", btn_add:"Ê∑ªÂä†", btn_import:"ÂØºÂÖ•", title_import:"Á≤òË¥¥ M3U", cat_action:"Âä®‰Ωú‰∏éÊøÄÊÉÖ", cat_scifi:"ÁßëÂπª‰∏éÊú™Êù•", cat_real:"ÁúüÂÆûÊïÖ‰∫ã", chat_welcome:"‰Ω†Â•Ω„ÄÇÊàëÊòØ‰Ω†ÁöÑÊô∫ËÉΩÂ§öÂ™í‰ΩìÂä©Êâã„ÄÇÈöè‰æøÈóÆ„ÄÇ", theme_title:"Â§ñËßÇ", data_title:"Êï∞ÊçÆ", donate_btn:"ËØ∑ÊàëÂñùÂíñÂï°" }
        };

        // --- INICIO ---
        window.addEventListener('load', () => {
            document.getElementById('langSelect').value = currentLang;
            updateTexts();
            document.getElementById('apiKey').value = apiKey;
            renderLibrary(); renderDiscovery();
            if(localStorage.getItem('vicomedia_theme') === 'matrix') {
                document.body.classList.add('matrix-mode');
                document.getElementById('themeLabel').innerText = "Modo Cyber";
            }
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
            lucide.createIcons();
        });

        // --- IDIOMAS ---
        window.changeLanguage = function(lang) {
            currentLang = lang; localStorage.setItem('vicomedia_lang', lang); updateTexts();
        };
        function updateTexts() {
            document.querySelectorAll('[data-t]').forEach(el => {
                if(TRANSLATIONS[currentLang][el.getAttribute('data-t')]) el.innerText = TRANSLATIONS[currentLang][el.getAttribute('data-t')];
            });
        }

        // --- NAVEGACI√ìN ---
        window.switchTab = function(viewId, btn) {
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(viewId === 'view-favorites') renderFavorites();
        };
        window.toggleInput = function(id) { document.getElementById(id).classList.toggle('hidden'); };

        // --- BIBLIOTECA ---
        function renderLibrary() {
            const grid = document.getElementById('library-grid');
            grid.innerHTML = '';
            library.forEach((item, index) => grid.appendChild(createCard(item, index)));
            lucide.createIcons();
        }

        function createCard(item, index) {
            const el = document.createElement('div');
            el.className = 'card';
            const img = item.cover && item.cover.length > 5 ? item.cover : 'https://placehold.co/300x450/111/00fff7?text=MEDIA';
            
            // Dos botones de reproducci√≥n: Play (Intenta saltar) y Web (Iframe seguro)
            el.innerHTML = `
                <div class="card-actions">
                    <button class="mini-btn edit" onclick="openEditMode(${index})"><i data-lucide="edit-2" style="width:14px"></i></button>
                    <button class="mini-btn fav ${item.fav ? 'active' : ''}" onclick="toggleFav(${index})"><i data-lucide="heart" style="width:14px"></i></button>
                    <button class="mini-btn" onclick="deleteItem(${index})" style="color:red"><i data-lucide="trash" style="width:14px"></i></button>
                </div>
                <img src="${img}" onerror="this.src='https://placehold.co/300x450/222/555?text=Error'">
                
                <div class="play-actions">
                    <button class="play-btn" onclick="playMedia('${item.url.replace(/'/g, "\\'")}', '${item.title.replace(/'/g, "\\'")}', false)">
                        <i data-lucide="play" size="16"></i> Play Now
                    </button>
                    <button class="web-btn" onclick="playMedia('${item.url.replace(/'/g, "\\'")}', '${item.title.replace(/'/g, "\\'")}', true)">
                        <i data-lucide="globe" size="16"></i> Web
                    </button>
                </div>
                <div class="card-info"><div class="card-title">${item.title}</div></div>
            `;
            return el;
        }

        // Editar/A√±adir
        window.openEditMode = function(index = -1) {
            const modal = document.getElementById('input-manual');
            document.getElementById('editIndex').value = index;
            if(index >= 0) {
                document.getElementById('mTitle').value = library[index].title;
                document.getElementById('mUrl').value = library[index].url;
                document.getElementById('mCover').value = library[index].cover;
                document.getElementById('saveBtn').innerText = "Actualizar";
                document.getElementById('formTitle').innerText = "Editar Video";
            } else {
                document.getElementById('mTitle').value = ''; document.getElementById('mUrl').value = ''; document.getElementById('mCover').value = '';
                document.getElementById('saveBtn').innerText = "Guardar"; document.getElementById('formTitle').innerText = "A√±adir Video";
            }
            modal.classList.remove('hidden'); modal.scrollIntoView({behavior: "smooth"});
        };

        window.saveMedia = function() {
            const idx = parseInt(document.getElementById('editIndex').value);
            const t = document.getElementById('mTitle').value, u = document.getElementById('mUrl').value, c = document.getElementById('mCover').value;
            if(!t || !u) return alert("Faltan datos");
            if(idx >= 0) { library[idx].title = t; library[idx].url = u; library[idx].cover = c; } 
            else { library.unshift({ title: t, url: u, cover: c, fav: false }); }
            saveData(); toggleInput('input-manual');
        };

        window.importList = function() {
            const lines = document.getElementById('mList').value.split('\n');
            for(let i=0; i<lines.length; i++) {
                if(lines[i].trim().startsWith('#EXTINF')) {
                    let title = lines[i].split(',')[1] || 'Sin T√≠tulo', url = lines[i+1]?.trim();
                    if(url && url.startsWith('http')) { library.push({ title, url, cover: '', fav: false }); i++; }
                }
            }
            saveData(); toggleInput('input-list'); alert('Lista procesada.');
        };

        window.toggleFav = function(i) { library[i].fav = !library[i].fav; saveData(); };
        window.deleteItem = function(i) { if(confirm('¬øBorrar?')) { library.splice(i, 1); saveData(); } };
        function saveData() { localStorage.setItem('vicomedia_lib', JSON.stringify(library)); renderLibrary(); renderFavorites(); }

        // --- DISCOVERY & TRAILERS FAVORITOS ---
        // Base de datos de trailers extendida
        const allTrailers = {
            action: [ { t:"Gladiator II", id:"4rgYUipGJNo" }, { t:"Mission Impossible 8", id:"NOhDyUmT9z0" }, { t:"F1 Movie", id:"6M_i40lB9bA" }, { t:"Kraven", id:"rze8QYwWGCE" }, { t:"Captain America", id:"1pHDWnXmK7Y" }, { t:"Thunderbolts", id:"v-7Xb1U4mO0" } ],
            scifi: [ { t:"Dune: Prophecy", id:"z2oJ4n3b5k0" }, { t:"Mickey 17", id:"osYpGSz_0i4" }, { t:"Alien: Romulus", id:"x0XDEhPfrbQ" }, { t:"Tron: Ares", id:"8tPNgCb_q1I" }, { t:"Avatar 3", id:"cZ7LzE3u7Bw" }, { t:"The Matrix 5", id:"9ix7TUGVYIo" } ],
            real: [ { t:"A Complete Unknown", id:"H3c1r0e3" }, { t:"Oppenheimer", id:"uYPbbksJxIg" }, { t:"Napoleon", id:"OAZWXUkrjPc" }, { t:"Ferrari", id:"KZNnKziPzzM" }, { t:"Iron Claw", id:"8QCAXF1n2vY" }, { t:"Bob Marley", id:"ajw425Kjvtw" } ]
        };

        function renderDiscovery() {
            // Mezclar trailers diariamente simulado (usando el d√≠a del mes para saltar el orden)
            const day = new Date().getDate();
            
            const shuffle = (arr) => arr.map((val, i) => [val, (i + day) % arr.length]).sort((a,b)=>a[1]-b[1]).map(a=>a[0]);

            const buildHTML = (list) => list.map(v => {
                const isFav = trailerFavs.some(f => f.id === v.id) ? 'active' : '';
                return `
                <div class="trailer-card">
                    <button onclick="toggleTrailerFav('${v.id}', '${v.t.replace(/'/g, "\\'")}')" class="mini-btn fav ${isFav}" style="position:absolute; top:5px; right:5px; z-index:10;"><i data-lucide="heart" size="14"></i></button>
                    <a href="https://youtube.com/watch?v=${v.id}" target="_blank" style="text-decoration:none; color:white;">
                        <img src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg">
                        <div class="trailer-overlay"><i data-lucide="external-link" size="32" style="color:var(--primary)"></i></div>
                        <div style="padding:8px; font-size:0.75rem;">${v.t}</div>
                    </a>
                </div>
                `;
            }).join('');

            document.getElementById('feed-action').innerHTML = buildHTML(shuffle(allTrailers.action));
            document.getElementById('feed-scifi').innerHTML = buildHTML(shuffle(allTrailers.scifi));
            document.getElementById('feed-real').innerHTML = buildHTML(shuffle(allTrailers.real));
            lucide.createIcons();
        }

        window.toggleTrailerFav = function(id, title) {
            const index = trailerFavs.findIndex(f => f.id === id);
            if(index > -1) trailerFavs.splice(index, 1);
            else trailerFavs.push({id, title});
            localStorage.setItem('vicomedia_tfavs', JSON.stringify(trailerFavs));
            renderDiscovery(); renderFavorites();
        };

        function renderFavorites() {
            // 1. Mis Videos
            const grid = document.getElementById('fav-grid');
            grid.innerHTML = '';
            library.filter(i => i.fav).forEach(item => grid.appendChild(createCard(item, library.indexOf(item))));
            
            // 2. Trailers
            const tGrid = document.getElementById('fav-trailers-grid');
            tGrid.innerHTML = '';
            if(trailerFavs.length === 0) tGrid.innerHTML = '<p style="color:#555; font-size:0.8rem;">No hay tr√°ilers guardados.</p>';
            trailerFavs.forEach(v => {
                tGrid.innerHTML += `
                <div class="trailer-card" style="margin-bottom:10px;">
                    <button onclick="toggleTrailerFav('${v.id}', '')" class="mini-btn fav active" style="position:absolute; top:5px; right:5px; z-index:10;"><i data-lucide="trash" size="14"></i></button>
                    <a href="https://youtube.com/watch?v=${v.id}" target="_blank" style="text-decoration:none; color:white;">
                        <img src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg">
                        <div style="padding:8px; font-size:0.75rem;">${v.title}</div>
                    </a>
                </div>`;
            });
            lucide.createIcons();
        }

        // --- REPRODUCTOR (El coraz√≥n del sistema) ---
        window.playMedia = function(url, title, forceWeb) {
            const modal = document.getElementById('playerModal');
            document.getElementById('playerTitle').innerText = title;
            const wrap = document.getElementById('videoWrapper');
            
            let html = '';
            // Es YouTube
            if(url.includes('youtube') || url.includes('youtu.be')) {
                let vid = url.split('v=')[1] || url.split('/').pop();
                if(vid.includes('&')) vid = vid.split('&')[0];
                html = `<iframe src="https://www.youtube.com/embed/${vid}?autoplay=1" allowfullscreen></iframe>`;
            } 
            // Es Archivo Directo (Play Now)
            else if(!forceWeb && url.match(/\.(mp4|webm|mkv|m3u8)$/i)) {
                html = `<video src="${url}" controls autoplay style="width:100%;height:100%"></video>`;
            } 
            // Es Web Externa (Sandbox extremo para asfixiar pop-ups y redirecciones malignas)
            else {
                // sandbox: permite scripts b√°sicos, pero bloquea popups y navegaci√≥n superior
                html = `
                <iframe src="${url}" 
                        sandbox="allow-scripts allow-same-origin allow-forms" 
                        allowfullscreen>
                </iframe>
                <div class="ad-block-warning">üõ°Ô∏è Escudo Anti Pop-Ups Activado</div>`;
            }
            
            wrap.innerHTML = html;
            modal.classList.remove('hidden');
        };

        window.closePlayer = function() {
            document.getElementById('videoWrapper').innerHTML = '';
            document.getElementById('playerModal').classList.add('hidden');
        };

        // --- CHAT AG√âNTICO REAL (GROQ) ---
        window.saveApiKey = function() {
            apiKey = document.getElementById('apiKey').value.trim();
            localStorage.setItem('vicomedia_apikey', apiKey);
            alert('API Key Guardada');
        };

        window.sendChat = async function() {
            const inp = document.getElementById('chatInput');
            const txt = inp.value;
            if(!txt) return;
            
            const box = document.getElementById('chatBox');
            box.innerHTML += `<div class="chat-msg msg-user">${txt}</div>`;
            inp.value = '';
            box.scrollTop = box.scrollHeight;

            if(apiKey.startsWith('gsk_')) {
                const loadingId = "load_" + Date.now();
                box.innerHTML += `<div class="chat-msg msg-ai" id="${loadingId}">Conectando con Groq...</div>`;
                box.scrollTop = box.scrollHeight;

                try {
                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: "POST",
                        headers: { 
                            "Authorization": `Bearer ${apiKey}`, 
                            "Content-Type": "application/json" 
                        },
                        body: JSON.stringify({
                            messages: [
                                { role: "system", content: "Eres VICO MEDIA, un experto sarc√°stico y muy inteligente en cine y series. Responde de forma concisa pero √∫til." },
                                { role: "user", content: txt }
                            ],
                            model: "llama3-8b-8192", // Modelo m√°s r√°pido y compatible
                            temperature: 0.7
                        })
                    });
                    
                    if(!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || "Error en la petici√≥n");
                    }

                    const data = await response.json();
                    document.getElementById(loadingId).remove();
                    const aiText = data.choices[0].message.content;
                    box.innerHTML += `<div class="chat-msg msg-ai">VICO: ${aiText}</div>`;
                } catch(e) {
                    document.getElementById(loadingId).remove();
                    box.innerHTML += `<div class="chat-msg msg-error">‚ö†Ô∏è Error API: ${e.message}. (Verifica que tu API Key sea correcta y tenga saldo).</div>`;
                }
            } else {
                box.innerHTML += `<div class="chat-msg msg-error">‚ö†Ô∏è Por favor, pon una API Key v√°lida de Groq (empieza por gsk_) en los Ajustes del Chat.</div>`;
            }
            box.scrollTop = box.scrollHeight;
        };

        // --- SETTINGS ---
        window.toggleTheme = function() {
            document.body.classList.toggle('matrix-mode');
            const isMatrix = document.body.classList.contains('matrix-mode');
            localStorage.setItem('vicomedia_theme', isMatrix ? 'matrix' : 'cyber');
            document.getElementById('themeLabel').innerText = isMatrix ? "Modo Cyber" : "Modo Matrix";
        };
        window.exportData = function() {
            const blob = new Blob([JSON.stringify({lib: library, favs: trailerFavs})], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "vico_backup.json"; a.click();
        };
        window.importData = function(input) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.lib) { library = d.lib; trailerFavs = d.favs || []; } else { library = d; }
                    saveData(); localStorage.setItem('vicomedia_tfavs', JSON.stringify(trailerFavs)); alert('Restaurado');
                } catch(err) { alert('Error JSON'); }
            };
            if(input.files[0]) reader.readAsText(input.files[0]);
        };
    </script>
</body>
</html>
