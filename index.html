<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VICO MEDIA</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        :root { --bg-color: #050505; --card-bg: #111; --primary: #00fff7; --secondary: #ff00ff; --text: #fff; }
        body.matrix-mode { --bg-color: #000; --card-bg: #0a140a; --primary: #00ff00; --secondary: #008f11; --text: #e0ffe0; }

        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text); padding-bottom: 90px; overflow-x: hidden; transition: 0.3s; }
        h1, h2, h3, button, select { font-family: 'Orbitron', sans-serif; }
        .hidden { display: none !important; }

        header { padding: 15px; background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%); border-bottom: 1px solid var(--primary); position: sticky; top: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(10px); }
        .logo-text { font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px var(--primary); }
        .logo-accent { color: var(--secondary); }
        .lang-select { background: #111; color: var(--primary); border: 1px solid var(--primary); padding: 5px; border-radius: 4px; font-size: 0.7rem; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(8,8,8,0.95); border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; backdrop-filter: blur(5px); }
        .nav-btn { background: none; border: none; color: #666; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; gap: 4px; cursor: pointer;}
        .nav-btn.active { color: var(--primary); text-shadow: 0 0 5px var(--primary); }
        
        main { padding: 20px; max-width: 1200px; margin: 0 auto; }

        .action-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-neon { flex: 1; padding: 10px; background: transparent; border: 1px solid var(--primary); color: var(--primary); box-shadow: 0 0 5px var(--primary); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.8rem; border-radius: 4px; }
        .btn-neon:active { background: var(--primary); color: black; }
        .btn-neon.alt { border-color: var(--secondary); color: var(--secondary); box-shadow: 0 0 5px var(--secondary); }
        .btn-neon.alt:active { background: var(--secondary); color: black; }
        
        .input-box { background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px; }
        input, textarea, select { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border-radius: 4px; }

        .cat-scroll { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 15px; }
        .cat-pill { padding: 5px 15px; background: #222; border: 1px solid #444; border-radius: 20px; font-size: 0.8rem; cursor: pointer; white-space: nowrap; }
        .cat-pill.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: bold; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: var(--card-bg); border-radius: 8px; overflow: hidden; position: relative; border: 1px solid #333; transition: 0.2s; display: flex; flex-direction: column; }
        .card img { width: 100%; height: 220px; object-fit: cover; background: #222; display: block; }
        .card-info { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: var(--text); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .card-actions-top { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 10; flex-direction: column; }
        .mini-btn { background: rgba(0,0,0,0.8); color: white; border: 1px solid #333; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;}
        .mini-btn.fav.active { color: var(--secondary); border-color: var(--secondary); }
        .cat-select { font-size: 0.7rem; padding: 2px; background: #000; color: var(--primary); border: 1px solid #333; width: 100%; margin-bottom: 10px; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .btn-sm { font-size: 0.65rem; padding: 6px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .btn-play { background: var(--primary); color: #000; }
        .btn-web { background: #444; color: white; border: 1px solid #666; }
        .btn-ext { background: transparent; color: var(--secondary); border: 1px solid var(--secondary); }
        .btn-share { background: #0070ba; color: white; }

        .discovery-header { border-left: 4px solid var(--secondary); padding-left: 10px; margin: 20px 0 10px; }
        .video-scroll { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; }
        .trailer-card { min-width: 220px; background: #111; border-radius: 8px; overflow: hidden; border: 1px solid #333; position: relative; }
        .trailer-card img { width: 100%; height: 125px; object-fit: cover; }
        .trailer-overlay { position: absolute; top:0; left:0; width:100%; height:125px; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; }
        .rss-item { padding: 10px; border-bottom: 1px solid #333; font-size: 0.85rem; }
        .rss-item a { color: var(--primary); text-decoration: none; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; display: flex; flex-direction: column; }
        .modal-header { padding: 10px; background: #111; border-bottom: 1px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .video-container { flex: 1; background: black; display: flex; align-items: center; justify-content: center; position: relative; }
        iframe, video { width: 100%; height: 100%; border: none; }
        .ad-warning { position: absolute; top: 10px; background: rgba(0,0,0,0.8); color: var(--secondary); padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; border: 1px solid var(--secondary); z-index: 50; pointer-events: none;}

        .chat-window { height: 350px; background: var(--card-bg); border: 1px solid #333; margin-bottom: 10px; padding: 10px; overflow-y: auto; border-radius: 8px; }
        .chat-msg { margin-bottom: 8px; padding: 10px; border-radius: 8px; font-size: 0.9rem; max-width: 85%; word-wrap: break-word; }
        .msg-user { background: #222; margin-left: auto; color: white; border-right: 3px solid #555; }
        .msg-ai { background: rgba(0, 255, 247, 0.05); border: 1px solid #333; color: var(--text); border-left: 3px solid var(--primary); }
        .msg-error { background: rgba(255, 0, 0, 0.1); border: 1px solid red; color: #ff6b6b; font-size: 0.8rem;}

        .credits-box { text-align: center; margin-top: 20px; padding: 20px; border-top: 1px solid #333; }
        .paypal-btn { background: #0070ba; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: bold; cursor: pointer; display: inline-flex; gap: 8px; align-items: center; margin-top: 10px; text-decoration: none; }
        .link-ln { color: #0a66c2; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <div class="logo-text">VICO <span class="logo-accent">MEDIA</span></div>
        <select id="langSelect" class="lang-select" onchange="changeLanguage(this.value)">
            <option value="es">üá™üá∏ ES</option>
            <option value="en">üá∫üá∏ EN</option>
        </select>
    </header>

    <main>
        <section id="view-library">
            <div class="action-bar">
                <button onclick="openEditMode()" class="btn-neon"><i data-lucide="plus"></i> A√±adir</button>
                <button onclick="toggleInput('input-list')" class="btn-neon alt"><i data-lucide="list"></i> Importar</button>
                <button onclick="toggleInput('input-category')" class="btn-neon" style="border-color:#555; color:#aaa"><i data-lucide="folder-plus"></i> Categor√≠as</button>
            </div>

            <div id="input-category" class="input-box hidden">
                <h3>A√±adir Categor√≠a</h3>
                <div style="display:flex; gap:5px">
                    <input type="text" id="newCatName" placeholder="Ej: Anime">
                    <button onclick="addCategory()" class="btn-neon">Guardar</button>
                </div>
            </div>

            <div id="input-manual" class="input-box hidden">
                <h3 id="formTitle">A√±adir Video</h3>
                <input type="hidden" id="editIndex" value="-1">
                <input type="text" id="mTitle" placeholder="T√≠tulo">
                <input type="text" id="mUrl" placeholder="URL (mp4, m3u8, web...)">
                <input type="text" id="mCover" placeholder="Imagen URL (Opcional)">
                <div style="display:flex; gap:10px">
                    <button onclick="saveMedia()" class="btn-neon" id="saveBtn">Guardar</button>
                    <button onclick="toggleInput('input-manual')" class="btn-neon" style="border-color:red; color:red">Cancelar</button>
                </div>
            </div>

            <div id="input-list" class="input-box hidden">
                <h3>Pegar Lista (M3U / Wiseplay)</h3>
                <textarea id="mList" rows="5" placeholder="#EXTINF:-1, Titulo..."></textarea>
                <button onclick="importList()" class="btn-neon alt" style="width:100%">Procesar Lote</button>
            </div>

            <div class="cat-scroll" id="cat-filters"></div>
            <div id="library-grid" class="grid"></div>
        </section>

     <section id="view-discovery" class="hidden">
            <h2 style="color:var(--secondary)">Discovery 2026</h2>
            
            <div class="input-box" style="margin-top:10px;">
                <h3 style="font-size:0.9rem; margin-top:0"><i data-lucide="search"></i> Buscar Info Pel√≠culas</h3>
                <div style="display:flex; gap:5px">
                    <input type="text" id="searchWiki" placeholder="Ej: Spider-Man 4">
                    <button onclick="searchMovieInfo()" class="btn-neon">Buscar</button>
                </div>
                <div id="searchResults" style="margin-top:10px; font-size:0.8rem; color:#aaa;"></div>
            </div>
            
            <div class="input-box">
                <h3 style="font-size:0.9rem; margin-top:0"><i data-lucide="film"></i> Explorador de Tr√°ilers</h3>
                <select id="trailerCategory" style="margin-bottom:10px; background:#000; border:1px solid var(--secondary); color:var(--secondary);">
                    <option value="ciencia_ficcion">Ciencia Ficci√≥n</option>
                    <option value="historia">Historia</option>
                    <option value="sagas">Sagas</option>
                    <option value="familiar">Familiar</option>
                    <option value="navidad">Navidad</option>
                    <option value="biblicas">B√≠blicas</option>
                    <option value="drama">Drama</option>
                    <option value="animacion">Animaci√≥n</option>
                    <option value="infantil">Infantil</option>
                    <option value="comedia">Comedia</option>
                    <option value="documentales">Documentales</option>
                </select>
                <div style="display:flex; gap:10px;">
                    <button onclick="loadTrailers()" class="btn-neon alt" style="flex:1; padding:8px; font-size:0.75rem;"><i data-lucide="refresh-cw"></i> Recargar Tr√°ilers</button>
                    <button onclick="searchFreeMovies()" class="btn-neon" style="flex:1; padding:8px; font-size:0.75rem; border-color:red; color:white; background:#aa0000;"><i data-lucide="youtube"></i> Pelis Gratis</button>
                </div>
            </div>

            <div class="discovery-header"><h3 id="trailer-section-title">Tr√°ilers Recomendados</h3></div>
            <div class="video-scroll" id="dynamic-trailers">
                </div>

            <div class="discovery-header"><h3>üì∞ Cine News (RSS)</h3></div>
            <div id="rss-feed" style="background:#111; border-radius:8px; border:1px solid #333; max-height:250px; overflow-y:auto;">
                <p style="padding:10px; color:#666">Cargando noticias...</p>
            </div>
        </section>
                <div id="searchResults" style="margin-top:10px; font-size:0.8rem; color:#aaa;"></div>
            </div>
            
            <div class="discovery-header"><h3>üî• Blockbusters 2026</h3></div>
            <div class="video-scroll" id="feed-action"></div>

            <div class="discovery-header"><h3>üõ∏ Sci-Fi & Fantas√≠a</h3></div>
            <div class="video-scroll" id="feed-scifi"></div>

            <div class="discovery-header"><h3>üì∞ Cine News (RSS)</h3></div>
            <div id="rss-feed" style="background:#111; border-radius:8px; border:1px solid #333; max-height:250px; overflow-y:auto;">
                <p style="padding:10px; color:#666">Cargando noticias...</p>
            </div>
        </section>

        <section id="view-favorites" class="hidden">
            <h2 style="color:var(--secondary)"><i data-lucide="heart"></i> Favoritos</h2>
            <h3 style="margin-top:20px; font-size:1rem; border-bottom:1px solid #333; padding-bottom:5px;">Mis Videos</h3>
            <div id="fav-grid" class="grid"></div>

            <h3 style="margin-top:20px; font-size:1rem; border-bottom:1px solid #333; padding-bottom:5px;">Tr√°ilers Guardados</h3>
            <div id="fav-trailers-grid" class="grid"></div>
        </section>

        <section id="view-chat" class="hidden">
            <h2>Chat Inteligente</h2>
            
            <div class="input-box" id="api-box">
                <label style="font-size:0.8rem; color:var(--primary)">Motor IA (Auto-detectado):</label>
                <select id="apiProvider" style="margin-bottom:5px; background:#111; color:#888;">
                    <option value="gemini">Google Gemini</option>
                    <option value="groq">Groq</option>
                    <option value="openai">OpenAI (ChatGPT)</option>
                    <option value="deepseek">DeepSeek</option>
                </select>
                <input type="password" id="apiKey" placeholder="Pega tu API Key (AIza..., gsk_..., sk-...)" style="margin:0" oninput="detectApiKey(this.value)">
                <button onclick="saveApiKey()" class="btn-neon" style="margin-top:10px; width:100%">Guardar Configuraci√≥n</button>
                <p id="apiStatus" style="font-size:0.65rem; color:#666; margin-top:5px; text-align:center;">Pega tu clave para detectar el motor.</p>
            </div>

            <div id="chatBox" class="chat-window">
                <div class="chat-msg msg-ai">VICO: Hola. Soy tu experto en cine multi-API. Pega tu API Key y la detectar√© autom√°ticamente.</div>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="chatInput" placeholder="Ej: Resumen de Matrix..." style="margin:0">
                <button onclick="sendChat()" class="btn-neon"><i data-lucide="send"></i></button>
            </div>
        </section>

        <section id="view-settings" class="hidden">
            <h2>Configuraci√≥n</h2>
            <div class="input-box">
                <button onclick="toggleTheme()" class="btn-neon alt" style="width:100%">
                    <i data-lucide="sun"></i> <span id="themeLabel">Cambiar Modo Matrix</span>
                </button>
            </div>
            <div class="input-box">
                <h3 style="font-size:0.9rem; margin-top:0">Datos y Backups</h3>
                <button onclick="exportData()" class="btn-neon" style="width:100%; margin-bottom:10px;"><i data-lucide="download"></i> Exportar Todo</button>
                <div style="position:relative">
                    <button class="btn-neon alt" style="width:100%"><i data-lucide="upload"></i> Restaurar JSON</button>
                    <input type="file" onchange="importData(this)" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                </div>
            </div>

            <div class="credits-box">
                <a href="https://www.paypal.com/paypalme/texiduvi" target="_blank" class="paypal-btn">
                    <i data-lucide="coffee"></i> Inv√≠tame un Caf√©
                </a>
                
                <div style="margin-top: 25px; font-size: 0.8rem; color: #888; line-height: 1.6;">
                    &copy; 2026 VICO MEDIA App. Todos los derechos reservados.<br>
                    Creado por <a href="https://www.linkedin.com/in/jaime-andr√©s-due√±as-vicu√±a" target="_blank" class="link-ln"><i data-lucide="linkedin" size="14"></i> Jaime Andr√©s Due√±as Vicu√±a</a>
                </div>
            </div>
        </section>

    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('view-library', this)"><i data-lucide="film"></i> Biblio</button>
        <button class="nav-btn" onclick="switchTab('view-discovery', this)"><i data-lucide="compass"></i> Discovery</button>
        <button class="nav-btn" onclick="switchTab('view-favorites', this)"><i data-lucide="heart"></i> Favs</button>
        <button class="nav-btn" onclick="switchTab('view-chat', this)"><i data-lucide="bot"></i> Chat</button>
        <button class="nav-btn" onclick="switchTab('view-settings', this)"><i data-lucide="settings"></i> Ajustes</button>
    </nav>

    <div id="playerModal" class="modal hidden">
        <div class="modal-header">
            <span id="playerTitle" style="font-weight:bold; color:var(--primary); overflow:hidden; white-space:nowrap; max-width:80%;">Reproductor</span>
            <button onclick="closePlayer()" style="background:none; border:none; color:red; font-size:1.5rem; cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        <div id="videoWrapper" class="video-container"></div>
    </div>

    <script>
        let library = JSON.parse(localStorage.getItem('vicomedia_lib')) || [];
        let trailerFavs = JSON.parse(localStorage.getItem('vicomedia_tfavs')) || [];
        let apiKey = localStorage.getItem('vicomedia_apikey') || '';
        let apiProvider = localStorage.getItem('vicomedia_provider') || 'gemini';
        let defaultCategories = ["Acci√≥n", "Ciencia Ficci√≥n", "Comedia", "Drama", "Terror", "Thriller", "Romance", "Fantas√≠a", "Animaci√≥n", "Documental", "Aventura", "Crimen"];
        let categories = JSON.parse(localStorage.getItem('vicomedia_cats')) || defaultCategories;
        let activeCategory = 'Todos';

        window.addEventListener('load', () => {
            document.getElementById('apiKey').value = apiKey;
            document.getElementById('apiProvider').value = apiProvider;
            renderCategories(); renderLibrary(); renderDiscovery(); loadRSS();
            if(localStorage.getItem('vicomedia_theme') === 'matrix') document.body.classList.add('matrix-mode');
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
            lucide.createIcons();
        });

        window.switchTab = function(viewId, btn) {
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(viewId === 'view-favorites') renderFavorites();
        };
        window.toggleInput = function(id) { document.getElementById(id).classList.toggle('hidden'); };

        function renderCategories() {
            const container = document.getElementById('cat-filters');
            let html = `<button class="cat-pill ${activeCategory === 'Todos' ? 'active' : ''}" onclick="filterCat('Todos')">Todo</button>`;
            categories.forEach(c => { html += `<button class="cat-pill ${activeCategory === c ? 'active' : ''}" onclick="filterCat('${c}')">${c}</button>`; });
            container.innerHTML = html;
        }
        window.filterCat = function(cat) { activeCategory = cat; renderCategories(); renderLibrary(); };
        window.addCategory = function() {
            const val = document.getElementById('newCatName').value.trim();
            if(val && !categories.includes(val)) { categories.push(val); localStorage.setItem('vicomedia_cats', JSON.stringify(categories)); document.getElementById('newCatName').value = ''; renderCategories(); toggleInput('input-category'); }
        };

        function renderLibrary() {
            const grid = document.getElementById('library-grid');
            grid.innerHTML = '';
            let filtered = activeCategory === 'Todos' ? library : library.filter(i => i.cat === activeCategory);
            if(filtered.length === 0) { grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#555;">No hay videos aqu√≠.</p>'; return; }
            filtered.forEach(item => grid.appendChild(createCard(item, library.indexOf(item))));
            lucide.createIcons();
        }

        function createCard(item, index) {
            const el = document.createElement('div'); el.className = 'card';
            const img = item.cover && item.cover.length > 5 ? item.cover : 'https://placehold.co/300x450/111/00fff7?text=MEDIA';
            const safeUrl = item.url.replace(/'/g, "\\'"); const safeTitle = item.title.replace(/'/g, "\\'");
            let catOptions = `<option value="">Sin Categor√≠a</option>`;
            categories.forEach(c => { catOptions += `<option value="${c}" ${item.cat === c ? 'selected' : ''}>${c}</option>`; });

            el.innerHTML = `
                <div class="card-actions-top">
                    <button class="mini-btn" onclick="openEditMode(${index})"><i data-lucide="edit-2" size="14"></i></button>
                    <button class="mini-btn fav ${item.fav ? 'active' : ''}" onclick="toggleFav(${index})"><i data-lucide="heart" size="14"></i></button>
                    <button class="mini-btn" onclick="deleteItem(${index})" style="color:red"><i data-lucide="trash" size="14"></i></button>
                </div>
                <img src="${img}" onerror="this.src='https://placehold.co/300x450/222/555?text=Error'">
                <div class="card-info">
                    <div class="card-title">${item.title}</div>
                    <select class="cat-select" onchange="changeItemCat(${index}, this.value)">${catOptions}</select>
                    <div class="action-grid">
                        <button class="btn-sm btn-play" onclick="playMedia('${safeUrl}', '${safeTitle}', 'internal')"><i data-lucide="play" size="12"></i> Play Now</button>
                        <button class="btn-sm btn-web" onclick="playMedia('${safeUrl}', '${safeTitle}', 'iframe')"><i data-lucide="globe" size="12"></i> Iframe</button>
                        <button class="btn-sm btn-ext" onclick="window.open('${safeUrl}', '_blank')"><i data-lucide="external-link" size="12"></i> Externo</button>
                        <button class="btn-sm btn-share" onclick="shareUrl('${safeUrl}')"><i data-lucide="share-2" size="12"></i> Share</button>
                    </div>
                </div>
            `;
            return el;
        }

        window.shareUrl = function(url) {
            if (navigator.share) navigator.share({ title: 'Reproducir', url: url }).catch(console.error);
            else { alert("Usa VLC, UPlayer o Wiseplay para Android."); window.open(url, '_blank'); }
        };
        window.changeItemCat = function(index, newCat) { library[index].cat = newCat; saveData(); };
        window.openEditMode = function(index = -1) {
            const modal = document.getElementById('input-manual'); document.getElementById('editIndex').value = index;
            if(index >= 0) {
                document.getElementById('mTitle').value = library[index].title; document.getElementById('mUrl').value = library[index].url;
                document.getElementById('mCover').value = library[index].cover; document.getElementById('saveBtn').innerText = "Actualizar";
            } else {
                document.getElementById('mTitle').value = ''; document.getElementById('mUrl').value = ''; document.getElementById('mCover').value = '';
                document.getElementById('saveBtn').innerText = "Guardar";
            }
            modal.classList.remove('hidden'); modal.scrollIntoView({behavior: "smooth"});
        };
        window.saveMedia = function() {
            const idx = parseInt(document.getElementById('editIndex').value), t = document.getElementById('mTitle').value, u = document.getElementById('mUrl').value, c = document.getElementById('mCover').value;
            if(!t || !u) return alert("Faltan datos");
            if(idx >= 0) { library[idx].title = t; library[idx].url = u; library[idx].cover = c; } 
            else library.unshift({ title: t, url: u, cover: c, fav: false, cat: activeCategory==='Todos'?'':activeCategory });
            saveData(); toggleInput('input-manual');
        };
        
        window.toggleFav = function(i) { library[i].fav = !library[i].fav; saveData(); };
        window.deleteItem = function(i) { if(confirm('¬øBorrar?')) { library.splice(i, 1); saveData(); } };
        function saveData() { localStorage.setItem('vicomedia_lib', JSON.stringify(library)); renderLibrary(); renderFavorites(); }

// --- MOTOR DISCOVERY: TR√ÅILERS DIN√ÅMICOS Y PELIS GRATIS ---
        const trailerDatabase = {
            ciencia_ficcion: [ { t:"Avatar: Fire & Ash", id:"cZ7LzE3u7Bw" }, { t:"Dune: Messiah", id:"z2oJ4n3b5k0" }, { t:"Tron: Ares", id:"8tPNgCb_q1I" }, { t:"Mickey 17", id:"osYpGSz_0i4" }, { t:"Supergirl", id:"O-XpM1qgEUE" } ],
            historia: [ { t:"Gladiator II", id:"4rgYUipGJNo" }, { t:"Oppenheimer", id:"uYPbbksJxIg" }, { t:"Napoleon", id:"OAZWXUkrjPc" }, { t:"Killers of the Flower Moon", id:"EC3MACBDpEA" } ],
            sagas: [ { t:"Avengers: Doomsday", id:"r51cYJZmWuc" }, { t:"The Batman Part II", id:"c4L5n4xN19Y" }, { t:"Mission Impossible 8", id:"NOhDyUmT9z0" }, { t:"John Wick 5", id:"p_TivLksbOM" } ],
            familiar: [ { t:"Paddington in Peru", id:"7AofhD3HkOE" }, { t:"Mufasa: The Lion King", id:"o17MF9vnabg" }, { t:"Sonic 3", id:"qSu6i2iFMO0" } ],
            navidad: [ { t:"Red One", id:"U8WXJqGRQxc" }, { t:"Klaus", id:"taIGZJrsveA" }, { t:"The Grinch", id:"vhn1_ncE1j8" } ],
            biblicas: [ { t:"The Chosen (Season 4)", id:"_K_M6zT2eG4" }, { t:"Mary", id:"1X6-MhO1O3I" }, { t:"Exodus: Gods and Kings", id:"t-8YsafI5JM" } ],
            drama: [ { t:"A Complete Unknown", id:"H3c1r0e3wM8" }, { t:"The Iron Claw", id:"8QCAXF1n2vY" }, { t:"Ferrari", id:"KZNnKziPzzM" } ],
            animacion: [ { t:"Spider-Man: Beyond the Spider-Verse", id:"cqGjhVJWtEg" }, { t:"Toy Story 5", id:"3Z91oT_y0lE" }, { t:"Moana 2", id:"hDZ7y8RP5q4" } ],
            infantil: [ { t:"Despicable Me 4", id:"qQlr9-rF32A" }, { t:"Inside Out 2", id:"LEjhY15eCx0" }, { t:"Kung Fu Panda 4", id:"_inKs4eeHiI" } ],
            comedia: [ { t:"Deadpool & Wolverine", id:"73_1biulkYk" }, { t:"Ghostbusters: Frozen Empire", id:"HRjq_rcXpD0" }, { t:"Beetlejuice Beetlejuice", id:"hXZNV1A2m1I" } ],
            documentales: [ { t:"Planet Earth III", id:"eTGEhP8z2nQ" }, { t:"The Last Dance", id:"PqjGOCN_A8" }, { t:"Free Solo", id:"urRVZ4SW7WU" } ]
        };

        window.loadTrailers = function() {
            const selectEl = document.getElementById('trailerCategory');
            const cat = selectEl.value;
            const catName = selectEl.options[selectEl.selectedIndex].text;
            document.getElementById('trailer-section-title').innerText = "Tr√°ilers: " + catName;
            
            // Obtener lista y mezclarla aleatoriamente para simular contenido fresco al recargar
            let list = [...(trailerDatabase[cat] || [])];
            list.sort(() => Math.random() - 0.5);

            const html = list.map(v => {
                const isFav = trailerFavs.some(f => f.id === v.id) ? 'active' : '';
                return `
                <div class="trailer-card">
                    <button onclick="toggleTrailerFav('${v.id}', '${v.t.replace(/'/g, "\\'")}')" class="mini-btn fav ${isFav}" style="position:absolute; top:5px; right:5px; z-index:10;"><i data-lucide="heart" size="14"></i></button>
                    <a href="https://youtube.com/watch?v=${v.id}" target="_blank" style="text-decoration:none; color:white;">
                        <img src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg">
                        <div class="trailer-overlay"><i data-lucide="play-circle" size="32" style="color:var(--primary)"></i></div>
                        <div style="padding:8px; font-size:0.75rem;">${v.t}</div>
                    </a>
                </div>`;
            }).join('');
            
            document.getElementById('dynamic-trailers').innerHTML = html;
            if(window.lucide) lucide.createIcons();
        };

        // Funci√≥n puente para mantener la compatibilidad al iniciar
        function renderDiscovery() {
            loadTrailers();
        }

        // B√∫squeda directa de Pel√≠culas Gratis
        window.searchFreeMovies = function() {
            window.open('https://www.youtube.com/results?search_query=peliculas+completas+en+espa√±ol+gratis', '_blank');
        };
        window.searchMovieInfo = async function() {
            const query = document.getElementById('searchWiki').value, resDiv = document.getElementById('searchResults');
            if(!query) return; resDiv.innerHTML = "Buscando...";
            try {
                const res = await fetch(`https://es.wikipedia.org/w/api.php?action=query&origin=*&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(query)}&format=json`);
                const data = await res.json(); const pageId = Object.keys(data.query.pages)[0];
                if(pageId === "-1") resDiv.innerHTML = "No encontrado.";
                else resDiv.innerHTML = `<strong>${data.query.pages[pageId].title}</strong>: <br> ${data.query.pages[pageId].extract.substring(0, 300)}... <a href="https://es.wikipedia.org/wiki/${encodeURIComponent(data.query.pages[pageId].title)}" target="_blank" style="color:var(--primary)">Ver m√°s</a>`;
            } catch(e) { resDiv.innerHTML = "Error."; }
        };
        async function loadRSS() {
            try {
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://www.ecartelera.com/rss/noticias.xml')}`);
                const data = await res.json();
                if(data.items) document.getElementById('rss-feed').innerHTML = data.items.slice(0,5).map(i => `<div class="rss-item"><a href="${i.link}" target="_blank">üé¨ ${i.title}</a></div>`).join('');
            } catch(e) { document.getElementById('rss-feed').innerHTML = "<p style='color:red'>Error RSS.</p>"; }
        }
        function renderFavorites() {
            const grid = document.getElementById('fav-grid'); grid.innerHTML = '';
            library.filter(i => i.fav).forEach(item => grid.appendChild(createCard(item, library.indexOf(item))));
            const tGrid = document.getElementById('fav-trailers-grid'); tGrid.innerHTML = '';
            trailerFavs.forEach(v => {
                tGrid.innerHTML += `<div class="trailer-card" style="margin-bottom:10px;">
                    <button onclick="toggleTrailerFav('${v.id}', '')" class="mini-btn fav active" style="position:absolute; top:5px; right:5px; z-index:10;"><i data-lucide="trash" size="14"></i></button>
                    <a href="https://youtube.com/watch?v=${v.id}" target="_blank" style="text-decoration:none; color:white;">
                        <img src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg"><div style="padding:8px; font-size:0.75rem;">${v.title}</div>
                    </a></div>`;
            });
            lucide.createIcons();
        }

        window.playMedia = function(url, title, mode) {
            const modal = document.getElementById('playerModal'); document.getElementById('playerTitle').innerText = title;
            const wrap = document.getElementById('videoWrapper'); wrap.innerHTML = ''; 
            if(mode === 'iframe') {
                wrap.innerHTML = `<div class="ad-warning">üõ°Ô∏è Iframe Sandboxed</div><iframe src="${url}" sandbox="allow-scripts allow-same-origin allow-forms allow-presentation" allowfullscreen></iframe>`;
            } else if (mode === 'internal') {
                if(url.includes('youtube') || url.includes('youtu.be')) {
                    let vid = url.split('v=')[1] || url.split('/').pop(); if(vid.includes('&')) vid = vid.split('&')[0];
                    wrap.innerHTML = `<iframe src="https://www.youtube.com/embed/${vid}?autoplay=1" allowfullscreen></iframe>`;
                } else if(url.endsWith('.m3u8')) {
                    wrap.innerHTML = `<video id="hls-video" controls autoplay style="width:100%;height:100%"></video>`;
                    const video = document.getElementById('hls-video');
                    if (Hls.isSupported()) { const hls = new Hls(); hls.loadSource(url); hls.attachMedia(video); } 
                    else if (video.canPlayType('application/vnd.apple.mpegurl')) video.src = url;
                } else { wrap.innerHTML = `<video src="${url}" controls autoplay style="width:100%;height:100%"></video>`; }
            }
            modal.classList.remove('hidden');
        };
        window.closePlayer = function() { document.getElementById('videoWrapper').innerHTML = ''; document.getElementById('playerModal').classList.add('hidden'); };
// LECTOR AVANZADO DE LISTAS M3U (URLs Inteligentes y Texto)
        window.importList = async function() {
            const inputVal = document.getElementById('mList').value.trim();
            if(!inputVal) return;

            // Cambiamos el texto del bot√≥n para avisar que est√° descargando
            const btn = document.querySelector('#input-list .btn-neon.alt');
            const originalBtnText = btn.innerText;
            btn.innerText = "Descargando lista... ‚è≥";
            
            try {
                let textToParse = inputVal;

                // Magia: Si pegaste una URL, la descargamos usando un proxy anti-bloqueos
                if (inputVal.startsWith('http') && !inputVal.includes('\n')) {
                    const proxyUrl = "https://api.allorigins.win/raw?url="; 
                    const res = await fetch(proxyUrl + encodeURIComponent(inputVal));
                    if (!res.ok) throw new Error('No se pudo descargar');
                    textToParse = await res.text();
                }

                const lines = textToParse.split('\n');
                let count = 0;
                let newCatsFound = false;

                for(let i=0; i<lines.length; i++) {
                    let line = lines[i].trim();
                    
                    if(line.startsWith('#EXTINF')) {
                        // Extraer datos (Soporta listas complejas como TDTChannels)
                        let title = line.split(',').pop()?.trim() || 'Canal TV';
                        let catMatch = line.match(/group-title="([^"]+)"/i);
                        let category = catMatch ? catMatch[1].trim() : 'TV General';
                        let logoMatch = line.match(/tvg-logo="([^"]+)"/i);
                        let cover = logoMatch ? logoMatch[1].trim() : '';

                        // Buscar la URL del canal en las siguientes l√≠neas
                        let url = '';
                        let j = i + 1;
                        while(j < lines.length) {
                            let nextLine = lines[j].trim();
                            if(nextLine.startsWith('http')) {
                                url = nextLine;
                                i = j; // Saltamos hasta esta l√≠nea para no leer doble
                                break;
                            } else if (nextLine.startsWith('#EXTINF')) {
                                break; // Chocamos con otro canal, esta no ten√≠a link
                            }
                            j++;
                        }

                        if(url) {
                            if(category && !categories.includes(category)) {
                                categories.push(category);
                                newCatsFound = true;
                            }
                            library.push({ title, url, cover, fav: false, cat: category });
                            count++;
                        }
                    }
                }
                
                if(count > 0) {
                    if(newCatsFound) {
                        localStorage.setItem('vicomedia_cats', JSON.stringify(categories));
                        renderCategories();
                    }
                    saveData();
                    document.getElementById('mList').value = '';
                    toggleInput('input-list');
                    alert(`¬°√âxito! Se importaron ${count} canales y se organizaron por categor√≠as.`);
                } else {
                    alert('No se encontraron canales v√°lidos. Revisa el enlace.');
                }
            } catch (error) {
                alert('Error al descargar la lista. Aseg√∫rate de que el link p√∫blico sea v√°lido.');
            } finally {
                btn.innerText = originalBtnText; // Restauramos el bot√≥n
            }
        };
        // --- DETECCI√ìN Y CHAT (CORS Y AUTO-DETECCI√ìN REVISADOS) ---
        window.detectApiKey = function(key) {
            const prov = document.getElementById('apiProvider'), stat = document.getElementById('apiStatus');
            if(key.startsWith('AIza')) { prov.value = 'gemini'; stat.innerHTML = '<span style="color:var(--primary)">‚úÖ Gemini detectada.</span>'; }
            else if(key.startsWith('gsk_')) { prov.value = 'groq'; stat.innerHTML = '<span style="color:var(--primary)">‚úÖ Groq detectada.</span>'; }
            else if(key.startsWith('sk-')) { if(prov.value !== 'deepseek') prov.value = 'openai'; stat.innerHTML = '<span style="color:var(--primary)">‚úÖ OpenAI/DeepSeek detectada.</span>'; }
            else if(key.length > 5) stat.innerHTML = '<span style="color:#ff6b6b">‚ö†Ô∏è Formato desconocido.</span>';
            else stat.innerHTML = 'Pega tu clave para detectar.';
        };
        window.saveApiKey = function() {
            apiKey = document.getElementById('apiKey').value.trim(); apiProvider = document.getElementById('apiProvider').value;
            localStorage.setItem('vicomedia_apikey', apiKey); localStorage.setItem('vicomedia_provider', apiProvider); alert('Guardado');
        };
        
        window.sendChat = async function() {
            const inp = document.getElementById('chatInput'); const txt = inp.value; if(!txt) return;
            const box = document.getElementById('chatBox'); box.innerHTML += `<div class="chat-msg msg-user">${txt}</div>`;
            inp.value = ''; box.scrollTop = box.scrollHeight;
            if(!apiKey) { box.innerHTML += `<div class="chat-msg msg-error">‚ö†Ô∏è Falta la API Key.</div>`; return; }
            
            const loadingId = "load_" + Date.now();
            box.innerHTML += `<div class="chat-msg msg-ai" id="${loadingId}">Procesando con ${apiProvider.toUpperCase()}...</div>`;
            box.scrollTop = box.scrollHeight;

            try {
                let aiText = "";
                if(apiProvider === 'gemini') {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Eres experto en cine. " + txt }] }] })
                    });
                    const data = await res.json();
                    if(!res.ok) throw new Error(data.error?.message || "Error Gemini");
                    aiText = data.candidates[0].content.parts[0].text;
                } else {
                    let endpoint = "https://api.openai.com/v1/chat/completions", model = "gpt-4o-mini";
                    
                    // PROXY CORS APLICADO A GROQ
                    if(apiProvider === 'groq') { 
                        endpoint = "https://corsproxy.io/?https://api.groq.com/openai/v1/chat/completions"; 
                        model = "llama-3.3-70b-versatile"; 
                    }
                    if(apiProvider === 'deepseek') { 
                        endpoint = "https://api.deepseek.com/chat/completions"; 
                        model = "deepseek-chat"; 
                    }

                    const res = await fetch(endpoint, {
                        method: "POST", headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ messages: [{ role: "system", content: "Eres experto en cine." }, { role: "user", content: txt }], model: model })
                    });
                    const data = await res.json();
                    if(!res.ok) throw new Error(data.error?.message || "CORS o Key inv√°lida.");
                    aiText = data.choices[0].message.content;
                }
                document.getElementById(loadingId).remove();
                box.innerHTML += `<div class="chat-msg msg-ai">VICO: ${aiText}</div>`;
            } catch(e) {
                document.getElementById(loadingId).remove();
                box.innerHTML += `<div class="chat-msg msg-error">‚ö†Ô∏è Error: ${e.message}</div>`;
            }
            box.scrollTop = box.scrollHeight;
        };

        window.toggleTheme = function() { document.body.classList.toggle('matrix-mode'); localStorage.setItem('vicomedia_theme', document.body.classList.contains('matrix-mode') ? 'matrix' : 'cyber'); };
        window.exportData = function() { const blob = new Blob([JSON.stringify({lib: library, favs: trailerFavs, cats: categories})], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "vico_backup.json"; a.click(); };
        window.importData = function(input) {
            const r = new FileReader(); r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result); if(d.lib) { library = d.lib; trailerFavs = d.favs || []; categories = d.cats || defaultCategories; } else { library = d; }
                    saveData(); localStorage.setItem('vicomedia_tfavs', JSON.stringify(trailerFavs)); localStorage.setItem('vicomedia_cats', JSON.stringify(categories));
                    alert('Restaurado'); renderCategories();
                } catch(err) { alert('Error JSON'); }
            }; if(input.files[0]) r.readAsText(input.files[0]);
        };
    </script>
</body>
</html> 
