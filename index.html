<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VICO MEDIA</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        :root { --bg-color: #050505; --card-bg: #111; --primary: #00fff7; --secondary: #ff00ff; --text: #fff; }
        body.matrix-mode { --bg-color: #000; --card-bg: #0a140a; --primary: #00ff00; --secondary: #008f11; --text: #e0ffe0; }

        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text); padding-bottom: 90px; overflow-x: hidden; transition: 0.3s; }
        h1, h2, h3, button, select { font-family: 'Orbitron', sans-serif; }
        .hidden { display: none !important; }

        header { padding: 15px; background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%); border-bottom: 1px solid var(--primary); position: sticky; top: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(10px); }
        .logo-text { font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px var(--primary); }
        .logo-accent { color: var(--secondary); }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(8,8,8,0.95); border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; backdrop-filter: blur(5px); }
        .nav-btn { background: none; border: none; color: #666; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; gap: 4px; cursor: pointer;}
        .nav-btn.active { color: var(--primary); text-shadow: 0 0 5px var(--primary); }
        
        main { padding: 20px; max-width: 1200px; margin: 0 auto; }

        .action-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-neon { flex: 1; padding: 10px; background: transparent; border: 1px solid var(--primary); color: var(--primary); box-shadow: 0 0 5px var(--primary); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.8rem; border-radius: 4px; }
        .btn-neon:active { background: var(--primary); color: black; }
        .btn-neon.alt { border-color: var(--secondary); color: var(--secondary); box-shadow: 0 0 5px var(--secondary); }
        .btn-neon.alt:active { background: var(--secondary); color: black; }
        
        .input-box { background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px; }
        input, textarea, select { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border-radius: 4px; }

        .cat-scroll { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 15px; }
        .cat-pill { padding: 5px 15px; background: #222; border: 1px solid #444; border-radius: 20px; font-size: 0.8rem; cursor: pointer; white-space: nowrap; }
        .cat-pill.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: bold; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: var(--card-bg); border-radius: 8px; overflow: hidden; position: relative; border: 1px solid #333; transition: 0.2s; display: flex; flex-direction: column; }
        .card img { width: 100%; height: 220px; object-fit: cover; background: #222; display: block; }
        .card-info { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: var(--text); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .card-actions-top { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 10; flex-direction: column; }
        .mini-btn { background: rgba(0,0,0,0.8); color: white; border: 1px solid #333; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;}
        .mini-btn.fav.active { color: var(--secondary); border-color: var(--secondary); }
        .cat-select { font-size: 0.7rem; padding: 2px; background: #000; color: var(--primary); border: 1px solid #333; width: 100%; margin-bottom: 10px; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .btn-sm { font-size: 0.65rem; padding: 6px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .btn-play { background: var(--primary); color: #000; }
        .btn-web { background: #444; color: white; border: 1px solid #666; }
        .btn-ext { background: transparent; color: var(--secondary); border: 1px solid var(--secondary); }
        .btn-share { background: #0070ba; color: white; }

        .discovery-header { border-left: 4px solid var(--secondary); padding-left: 10px; margin: 20px 0 10px; display: flex; justify-content: space-between; align-items: center; }
        .video-scroll { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; }
        .trailer-card { min-width: 220px; background: #111; border-radius: 8px; overflow: hidden; border: 1px solid #333; position: relative; }
        .trailer-card img { width: 100%; height: 125px; object-fit: cover; }
        .trailer-overlay { position: absolute; top:0; left:0; width:100%; height:125px; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; }
        
        .rss-item { padding: 12px; border-bottom: 1px solid #333; font-size: 0.85rem; line-height: 1.4; }
        .rss-item a { color: var(--primary); text-decoration: none; font-weight: bold; }
        .rss-date { font-size: 0.65rem; color: #666; margin-top: 4px; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; display: flex; flex-direction: column; }
        .modal-header { padding: 10px; background: #111; border-bottom: 1px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .video-container { flex: 1; background: black; display: flex; align-items: center; justify-content: center; position: relative; }
        iframe, video { width: 100%; height: 100%; border: none; }
        .ad-warning { position: absolute; top: 10px; background: rgba(0,0,0,0.8); color: var(--secondary); padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; border: 1px solid var(--secondary); z-index: 50; pointer-events: none;}

        .chat-window { height: 350px; background: var(--card-bg); border: 1px solid #333; margin-bottom: 10px; padding: 10px; overflow-y: auto; border-radius: 8px; }
        .chat-msg { margin-bottom: 8px; padding: 10px; border-radius: 8px; font-size: 0.9rem; max-width: 85%; word-wrap: break-word; }
        .msg-user { background: #222; margin-left: auto; color: white; border-right: 3px solid #555; }
        .msg-ai { background: rgba(0, 255, 247, 0.05); border: 1px solid #333; color: var(--text); border-left: 3px solid var(--primary); }
        .msg-error { background: rgba(255, 0, 0, 0.1); border: 1px solid red; color: #ff6b6b; font-size: 0.8rem;}

        .credits-box { text-align: center; margin-top: 20px; padding: 20px; border-top: 1px solid #333; }
        .paypal-btn { background: #0070ba; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: bold; cursor: pointer; display: inline-flex; gap: 8px; align-items: center; margin-top: 10px; text-decoration: none; }
        .link-ln { color: #0a66c2; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <div class="logo-text">VICO <span class="logo-accent">MEDIA</span></div>
    </header>

    <main>
        <section id="view-library">
            <div class="action-bar">
                <button onclick="openEditMode()" class="btn-neon"><i data-lucide="plus"></i> A√±adir</button>
                <button onclick="toggleInput('input-list')" class="btn-neon alt"><i data-lucide="list"></i> Importar</button>
                <button onclick="toggleInput('input-category')" class="btn-neon" style="border-color:#555; color:#aaa"><i data-lucide="folder-plus"></i> Categor√≠as</button>
            </div>

            <div id="input-category" class="input-box hidden">
                <h3>A√±adir Categor√≠a</h3>
                <div style="display:flex; gap:5px">
                    <input type="text" id="newCatName" placeholder="Ej: Anime">
                    <button onclick="addCategory()" class="btn-neon">Guardar</button>
                </div>
            </div>

            <div id="input-manual" class="input-box hidden">
                <h3 id="formTitle">A√±adir Video</h3>
                <input type="hidden" id="editIndex" value="-1">
                <input type="text" id="mTitle" placeholder="T√≠tulo">
                <input type="text" id="mUrl" placeholder="URL (mp4, m3u8, web...)">
                <input type="text" id="mCover" placeholder="Imagen URL (Opcional)">
                <div style="display:flex; gap:10px">
                    <button onclick="saveMedia()" class="btn-neon" id="saveBtn">Guardar</button>
                    <button onclick="toggleInput('input-manual')" class="btn-neon" style="border-color:red; color:red">Cancelar</button>
                </div>
            </div>

            <div id="input-list" class="input-box hidden">
                <h3>Pegar Lista (M3U / Wiseplay)</h3>
                <textarea id="mList" rows="5" placeholder="#EXTINF:-1, Titulo..."></textarea>
                <button onclick="importList()" class="btn-neon alt" style="width:100%">Procesar Lote</button>
            </div>

            <div class="cat-scroll" id="cat-filters"></div>
            <div id="library-grid" class="grid"></div>
        </section>

        <section id="view-discovery" class="hidden">
            <h2 style="color:var(--secondary)">Discovery 2026</h2>
            
            <div class="input-box" style="margin-top:10px;">
                <h3 style="font-size:0.9rem; margin-top:0"><i data-lucide="search"></i> Buscar Info Pel√≠culas</h3>
                <div style="display:flex; gap:5px">
                    <input type="text" id="searchWiki" placeholder="Ej: Spider-Man 4">
                    <button onclick="searchMovieInfo()" class="btn-neon">Buscar</button>
                </div>
                <div id="searchResults" style="margin-top:10px; font-size:0.8rem; color:#aaa;"></div>
            </div>
            
            <div class="input-box">
                <h3 style="font-size:0.9rem; margin-top:0"><i data-lucide="youtube"></i> Explorador de Tr√°ilers Reales</h3>
                <select id="trailerCategory" style="margin-bottom:10px; background:#000; border:1px solid var(--secondary); color:var(--secondary);">
                    <option value="Acci√≥n">Acci√≥n y Adrenalina</option>
                    <option value="Ciencia Ficci√≥n">Ciencia Ficci√≥n</option>
                    <option value="Historia">Historia</option>
                    <option value="Sagas">Sagas y Franquicias</option>
                    <option value="Familiar">Familiar</option>
                    <option value="Navidad">Navidad</option>
                    <option value="B√≠blicas">B√≠blicas</option>
                    <option value="Drama">Drama</option>
                    <option value="Animaci√≥n">Animaci√≥n</option>
                    <option value="Infantil">Infantil</option>
                    <option value="Comedia">Comedia</option>
                    <option value="Documentales">Documentales</option>
                </select>
                <div style="display:flex; gap:10px;">
                    <button onclick="loadYouTubeTrailers()" class="btn-neon alt" style="flex:1; padding:8px; font-size:0.75rem;"><i data-lucide="refresh-cw"></i> Cargar Tr√°ilers</button>
                    <button onclick="searchFreeMovies()" class="btn-neon" style="flex:1; padding:8px; font-size:0.75rem; border-color:red; color:white; background:#aa0000;"><i data-lucide="film"></i> Pelis Gratis</button>
                </div>
            </div>

            <div class="discovery-header">
                <h3 id="trailer-section-title">√öltimos Tr√°ilers</h3>
            </div>
            <div class="video-scroll" id="dynamic-trailers">
                <p style="color:#555; padding:10px; font-size:0.8rem;">Selecciona una categor√≠a y dale a Cargar Tr√°ilers.</p>
            </div>

            <div class="discovery-header">
                <h3>üì∞ Cine News</h3>
                <button onclick="toggleInput('rss-settings')" class="btn-sm btn-web"><i data-lucide="settings" size="12"></i> Fuentes RSS</button>
            </div>
            
            <div id="rss-settings" class="input-box hidden" style="margin-bottom:10px;">
                <h4 style="margin-top:0; font-size:0.8rem;">Tus Fuentes de Noticias</h4>
                <div id="rss-list" style="margin-bottom:10px;"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="newRssUrl" placeholder="URL del RSS..." style="margin:0;">
                    <button onclick="addRss()" class="btn-neon">A√±adir</button>
                </div>
            </div>

            <div id="rss-feed" style="background:#111; border-radius:8px; border:1px solid #333; max-height:300px; overflow-y:auto;">
                <p style="padding:10px; color:#666">Cargando noticias...</p>
            </div>
        </section>

        <section id="view-favorites" class="hidden">
            <h2 style="color:var(--secondary)"><i data-lucide="heart"></i> Favoritos</h2>
            <h3 style="margin-top:20px; font-size:1rem; border-bottom:1px solid #333; padding-bottom:5px;">Mis Videos</h3>
            <div id="fav-grid" class="grid"></div>

            <h3 style="margin-top:20px; font-size:1rem; border-bottom:1px solid #333; padding-bottom:5px;">Tr√°ilers Guardados</h3>
            <div id="fav-trailers-grid" class="grid"></div>
        </section>

        <section id="view-chat" class="hidden">
            <h2>Chat Inteligente</h2>
            
            <div class="input-box" id="api-box">
                <label style="font-size:0.8rem; color:var(--primary)">Motor IA (Auto-detectado):</label>
                <select id="apiProvider" style="margin-bottom:5px; background:#111; color:#888;">
                    <option value="gemini">Google Gemini</option>
                    <option value="groq">Groq</option>
                    <option value="openai">OpenAI (ChatGPT)</option>
                    <option value="deepseek">DeepSeek</option>
                </select>
                <input type="password" id="apiKey" placeholder="Pega tu API Key (AIza..., gsk_..., sk-...)" style="margin:0" oninput="detectApiKey(this.value)">
                <button onclick="saveApiKey()" class="btn-neon" style="margin-top:10px; width:100%">Guardar Configuraci√≥n</button>
                <p id="apiStatus" style="font-size:0.65rem; color:#666; margin-top:5px; text-align:center;">Pega tu clave para detectar el motor.</p>
            </div>

            <div id="chatBox" class="chat-window">
                <div class="chat-msg msg-ai">VICO: Hola. Soy tu experto en cine multi-API. Pega tu API Key y la detectar√© autom√°ticamente.</div>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="chatInput" placeholder="Ej: Resumen de Matrix..." style="margin:0">
                <button onclick="sendChat()" class="btn-neon"><i data-lucide="send"></i></button>
            </div>
        </section>

        <section id="view-settings" class="hidden">
            <h2>Configuraci√≥n</h2>
            <div class="input-box">
                <button onclick="toggleTheme()" class="btn-neon alt" style="width:100%">
                    <i data-lucide="sun"></i> <span id="themeLabel">Cambiar Modo Matrix</span>
                </button>
            </div>
            <div class="input-box">
                <h3 style="font-size:0.9rem; margin-top:0">Datos y Backups</h3>
                <button onclick="exportData()" class="btn-neon" style="width:100%; margin-bottom:10px;"><i data-lucide="download"></i> Exportar Todo</button>
                <div style="position:relative">
                    <button class="btn-neon alt" style="width:100%"><i data-lucide="upload"></i> Restaurar JSON</button>
                    <input type="file" onchange="importData(this)" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                </div>
            </div>

            <div class="credits-box">
                <a href="https://www.paypal.com/paypalme/texiduvi" target="_blank" class="paypal-btn">
                    <i data-lucide="coffee"></i> Inv√≠tame un Caf√©
                </a>
                
                <div style="margin-top: 25px; font-size: 0.8rem; color: #888; line-height: 1.6;">
                    &copy; 2026 VICO MEDIA App. Todos los derechos reservados.<br>
                    Creado por <a href="https://www.linkedin.com/in/jaime-andr√©s-due√±as-vicu√±a" target="_blank" class="link-ln"><i data-lucide="linkedin" size="14"></i> Jaime Andr√©s Due√±as Vicu√±a</a>
                </div>
            </div>
        </section>

    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('view-library', this)"><i data-lucide="film"></i> Biblio</button>
        <button class="nav-btn" onclick="switchTab('view-discovery', this)"><i data-lucide="compass"></i> Discovery</button>
        <button class="nav-btn" onclick="switchTab('view-favorites', this)"><i data-lucide="heart"></i> Favs</button>
        <button class="nav-btn" onclick="switchTab('view-chat', this)"><i data-lucide="bot"></i> Chat</button>
        <button class="nav-btn" onclick="switchTab('view-settings', this)"><i data-lucide="settings"></i> Ajustes</button>
    </nav>

    <div id="playerModal" class="modal hidden">
        <div class="modal-header">
            <span id="playerTitle" style="font-weight:bold; color:var(--primary); overflow:hidden; white-space:nowrap; max-width:80%;">Reproductor</span>
            <button onclick="closePlayer()" style="background:none; border:none; color:red; font-size:1.5rem; cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        <div id="videoWrapper" class="video-container"></div>
    </div>

    <script>
        let library = JSON.parse(localStorage.getItem('vicomedia_lib')) || [];
        let trailerFavs = JSON.parse(localStorage.getItem('vicomedia_tfavs')) || [];
        let apiKey = localStorage.getItem('vicomedia_apikey') || '';
        let apiProvider = localStorage.getItem('vicomedia_provider') || 'gemini';
        let defaultCategories = ["Acci√≥n", "Ciencia Ficci√≥n", "Historia", "Sagas", "Familiar", "Navidad", "B√≠blicas", "Drama", "Animaci√≥n", "Infantil", "Comedia", "Documentales"];
        let categories = JSON.parse(localStorage.getItem('vicomedia_cats')) || defaultCategories;
        let activeCategory = 'Todos';

        // L√≥gica RSS
        let rssSources = JSON.parse(localStorage.getItem('vicomedia_rss')) || [
            'https://www.espinof.com/rss',
            'https://www.cinemascomics.com/feed'
        ];

        window.addEventListener('load', () => {
            document.getElementById('apiKey').value = apiKey;
            document.getElementById('apiProvider').value = apiProvider;
            renderCategories(); renderLibrary(); 
            loadYouTubeTrailers(); // Carga tr√°ilers de Acci√≥n al iniciar
            renderRssList(); loadRSS();
            if(localStorage.getItem('vicomedia_theme') === 'matrix') document.body.classList.add('matrix-mode');
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
            lucide.createIcons();
        });

        window.switchTab = function(viewId, btn) {
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(viewId === 'view-favorites') renderFavorites();
        };
        window.toggleInput = function(id) { document.getElementById(id).classList.toggle('hidden'); };

        function renderCategories() {
            const container = document.getElementById('cat-filters');
            let html = `<button class="cat-pill ${activeCategory === 'Todos' ? 'active' : ''}" onclick="filterCat('Todos')">Todo</button>`;
            categories.forEach(c => { html += `<button class="cat-pill ${activeCategory === c ? 'active' : ''}" onclick="filterCat('${c}')">${c}</button>`; });
            container.innerHTML = html;
        }
        window.filterCat = function(cat) { activeCategory = cat; renderCategories(); renderLibrary(); };
        window.addCategory = function() {
            const val = document.getElementById('newCatName').value.trim();
            if(val && !categories.includes(val)) { categories.push(val); localStorage.setItem('vicomedia_cats', JSON.stringify(categories)); document.getElementById('newCatName').value = ''; renderCategories(); toggleInput('input-category'); }
        };

        function renderLibrary() {
            const grid = document.getElementById('library-grid');
            grid.innerHTML = '';
            let filtered = activeCategory === 'Todos' ? library : library.filter(i => i.cat === activeCategory);
            if(filtered.length === 0) { grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#555;">No hay videos aqu√≠.</p>'; return; }
            filtered.forEach(item => grid.appendChild(createCard(item, library.indexOf(item))));
            lucide.createIcons();
        }

        function createCard(item, index) {
            const el = document.createElement('div'); el.className = 'card';
            const img = item.cover && item.cover.length > 5 ? item.cover : 'https://placehold.co/300x450/111/00fff7?text=MEDIA';
            const safeUrl = item.url.replace(/'/g, "\\'"); const safeTitle = item.title.replace(/'/g, "\\'");
            let catOptions = `<option value="">Sin Categor√≠a</option>`;
            categories.forEach(c => { catOptions += `<option value="${c}" ${item.cat === c ? 'selected' : ''}>${c}</option>`; });

            el.innerHTML = `
                <div class="card-actions-top">
                    <button class="mini-btn" onclick="openEditMode(${index})"><i data-lucide="edit-2" size="14"></i></button>
                    <button class="mini-btn fav ${item.fav ? 'active' : ''}" onclick="toggleFav(${index})"><i data-lucide="heart" size="14"></i></button>
                    <button class="mini-btn" onclick="deleteItem(${index})" style="color:red"><i data-lucide="trash" size="14"></i></button>
                </div>
                <img src="${img}" onerror="this.src='https://placehold.co/300x450/222/555?text=Error'">
                <div class="card-info">
                    <div class="card-title">${item.title}</div>
                    <select class="cat-select" onchange="changeItemCat(${index}, this.value)">${catOptions}</select>
                    <div class="action-grid">
                        <button class="btn-sm btn-play" onclick="playMedia('${safeUrl}', '${safeTitle}', 'internal')"><i data-lucide="play" size="12"></i> Play</button>
                        <button class="btn-sm btn-web" onclick="playMedia('${safeUrl}', '${safeTitle}', 'iframe')"><i data-lucide="globe" size="12"></i> Iframe</button>
                        <button class="btn-sm btn-ext" onclick="window.open('${safeUrl}', '_blank')"><i data-lucide="external-link" size="12"></i> Externo</button>
                        <button class="btn-sm btn-share" onclick="shareUrl('${safeUrl}')"><i data-lucide="share-2" size="12"></i> Share</button>
                    </div>
                </div>
            `;
            return el;
        }

        window.shareUrl = function(url) {
            if (navigator.share) navigator.share({ title: 'Reproducir Video', url: url }).catch(console.error);
            else { alert("Usa VLC, UPlayer o Wiseplay para Android."); window.open(url, '_blank'); }
        };
        window.changeItemCat = function(index, newCat) { library[index].cat = newCat; saveData(); };
        window.openEditMode = function(index = -1) {
            const modal = document.getElementById('input-manual'); document.getElementById('editIndex').value = index;
            if(index >= 0) {
                document.getElementById('mTitle').value = library[index].title; document.getElementById('mUrl').value = library[index].url;
                document.getElementById('mCover').value = library[index].cover; document.getElementById('saveBtn').innerText = "Actualizar";
            } else {
                document.getElementById('mTitle').value = ''; document.getElementById('mUrl').value = ''; document.getElementById('mCover').value = '';
                document.getElementById('saveBtn').innerText = "Guardar";
            }
            modal.classList.remove('hidden'); modal.scrollIntoView({behavior: "smooth"});
        };
        window.saveMedia = function() {
            const idx = parseInt(document.getElementById('editIndex').value), t = document.getElementById('mTitle').value, u = document.getElementById('mUrl').value, c = document.getElementById('mCover').value;
            if(!t || !u) return alert("Faltan datos");
            if(idx >= 0) { library[idx].title = t; library[idx].url = u; library[idx].cover = c; } 
            else library.unshift({ title: t, url: u, cover: c, fav: false, cat: activeCategory==='Todos'?'':activeCategory });
            saveData(); toggleInput('input-manual');
        };
        
        // Lector Inteligente M3U
        window.importList = async function() {
            const inputVal = document.getElementById('mList').value.trim();
            const btn = document.querySelector('#input-list .btn-neon.alt');
            const originalBtnText = btn.innerText;
            btn.innerText = "Procesando... ‚è≥";
            
            try {
                let textToParse = inputVal;
                if (!inputVal) {
                    textToParse = `#EXTM3U\n#EXTINF:-1 tvg-logo="https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/NASA_TV_logo.svg/512px-NASA_TV_logo.svg.png" group-title="Ciencia",NASA TV\nhttps://ntv1.akamaized.net/hls/live/2014075/NASA-NTV1-HLS/master.m3u8\n#EXTINF:-1 tvg-logo="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/Red_Bull_TV_logo.svg/512px-Red_Bull_TV_logo.svg.png" group-title="Deportes",Red Bull TV\nhttps://rbmn-live.akamaized.net/hls/live/590964/BoRB-AT/master.m3u8\n#EXTINF:-1 tvg-logo="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/Bloomberg_Television_logo.svg/512px-Bloomberg_Television_logo.svg.png" group-title="Noticias",Bloomberg\nhttps://live.bloomberg.tv/hls/live/2056637/us/master.m3u8`;
                } else if (inputVal.startsWith('http') && !inputVal.includes('\n')) {
                    const proxyUrl = "https://corsproxy.io/?"; 
                    const res = await fetch(proxyUrl + encodeURIComponent(inputVal));
                    if (!res.ok) throw new Error('Bloqueo');
                    textToParse = await res.text();
                }

                const lines = textToParse.replace(/\r\n/g, '\n').split('\n');
                let count = 0, newCatsFound = false;

                for(let i=0; i<lines.length; i++) {
                    let line = lines[i].trim();
                    if(line.startsWith('#EXTINF')) {
                        let title = line.split(',').pop()?.trim() || 'Canal';
                        let catMatch = line.match(/group-title="([^"]+)"/i) || line.match(/group-title=([^, ]+)/i);
                        let category = catMatch ? catMatch[1].trim() : 'General';
                        let logoMatch = line.match(/tvg-logo="([^"]+)"/i) || line.match(/tvg-logo=([^, ]+)/i);
                        let cover = logoMatch ? logoMatch[1].trim() : '';

                        let url = '', j = i + 1;
                        while(j < lines.length && j < i + 5) {
                            let nextLine = lines[j].trim();
                            if(nextLine.startsWith('http')) { url = nextLine; i = j; break; } 
                            else if (nextLine.startsWith('#EXTINF')) { break; }
                            j++;
                        }
                        if(url) {
                            if(category && !categories.includes(category)) { categories.push(category); newCatsFound = true; }
                            library.push({ title, url, cover, fav: false, cat: category }); count++;
                        }
                    }
                }
                if(count > 0) {
                    if(newCatsFound) { localStorage.setItem('vicomedia_cats', JSON.stringify(categories)); renderCategories(); }
                    saveData(); document.getElementById('mList').value = ''; toggleInput('input-list');
                    alert(`¬°Importados ${count} canales!`);
                } else alert('No se pudo leer. Truco: Pega el texto M3U completo.');
            } catch (error) { alert('URL bloqueada. Truco: Pega el c√≥digo de texto M3U en lugar del link.'); } 
            finally { btn.innerText = originalBtnText; }
        };

        window.toggleFav = function(i) { library[i].fav = !library[i].fav; saveData(); };
        window.deleteItem = function(i) { if(confirm('¬øBorrar?')) { library.splice(i, 1); saveData(); } };
        function saveData() { localStorage.setItem('vicomedia_lib', JSON.stringify(library)); renderLibrary(); renderFavorites(); }

        // --- B√öSQUEDA Y TR√ÅILERS (NUEVO MOTOR YOUTUBE) ---
        window.searchMovieInfo = async function() {
            const query = document.getElementById('searchWiki').value, resDiv = document.getElementById('searchResults');
            if(!query) return; resDiv.innerHTML = "Buscando...";
            try {
                const res = await fetch(`https://es.wikipedia.org/w/api.php?action=query&origin=*&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(query)}&format=json`);
                const data = await res.json(); const pageId = Object.keys(data.query.pages)[0];
                if(pageId === "-1") resDiv.innerHTML = "No encontrado.";
                else resDiv.innerHTML = `<strong>${data.query.pages[pageId].title}</strong>: <br> ${data.query.pages[pageId].extract.substring(0, 300)}... <a href="https://es.wikipedia.org/wiki/${encodeURIComponent(data.query.pages[pageId].title)}" target="_blank" style="color:var(--primary)">Ver m√°s</a>`;
            } catch(e) { resDiv.innerHTML = "Error."; }
        };

        window.searchFreeMovies = function() {
            window.open('https://www.youtube.com/results?search_query=peliculas+completas+en+espa√±ol+gratis', '_blank');
        };

        // Base de datos de respaldo (Fallback) en caso de que YouTube bloquee el Proxy
        const fallbackTrailers = {
            "Acci√≥n y Adrenalina": [ { id: "r51cYJZmWuc", t: "Avengers: Doomsday" }, { id: "c4L5n4xN19Y", t: "The Batman Part II" }, { id: "NOhDyUmT9z0", t: "Mission Impossible 8" }, { id: "1pHDWnXmK7Y", t: "Captain America: Brave New World" }, { id: "p_TivLksbOM", t: "John Wick 5" }, { id: "rze8QYwWGCE", t: "Kraven" } ],
            "Ciencia Ficci√≥n": [ { id: "cZ7LzE3u7Bw", t: "Avatar: Fire and Ash" }, { id: "z2oJ4n3b5k0", t: "Dune: Messiah" }, { id: "8tPNgCb_q1I", t: "Tron: Ares" }, { id: "osYpGSz_0i4", t: "Mickey 17" }, { id: "O-XpM1qgEUE", t: "Supergirl" } ],
            "Historia": [ { id: "4rgYUipGJNo", t: "Gladiator II" }, { id: "uYPbbksJxIg", t: "Oppenheimer" }, { id: "OAZWXUkrjPc", t: "Napoleon" }, { id: "aWzlQ2N6qqg", t: "The Brutalist" } ],
            "Sagas y Franquicias": [ { id: "Gj2sRz_O6Gk", t: "The Mandalorian & Grogu" }, { id: "73_1biulkYk", t: "Deadpool & Wolverine" }, { id: "x0XDEhPfrbQ", t: "Alien: Romulus" } ],
            "Familiar": [ { id: "7AofhD3HkOE", t: "Paddington in Peru" }, { id: "o17MF9vnabg", t: "Mufasa" }, { id: "qSu6i2iFMO0", t: "Sonic 3" } ],
            "Navidad": [ { id: "U8WXJqGRQxc", t: "Red One" }, { id: "vhn1_ncE1j8", t: "The Grinch" } ],
            "B√≠blicas": [ { id: "1X6-MhO1O3I", t: "Mary" }, { id: "_K_M6zT2eG4", t: "The Chosen" } ],
            "Drama": [ { id: "H3c1r0e3wM8", t: "A Complete Unknown" }, { id: "8QCAXF1n2vY", t: "The Iron Claw" }, { id: "KZNnKziPzzM", t: "Ferrari" } ],
            "Animaci√≥n": [ { id: "3Z91oT_y0lE", t: "Toy Story 5" }, { id: "hDZ7y8RP5q4", t: "Moana 2" }, { id: "cqGjhVJWtEg", t: "Spider-Man: Beyond the Spider-Verse" } ],
            "Infantil": [ { id: "qQlr9-rF32A", t: "Despicable Me 4" }, { id: "LEjhY15eCx0", t: "Inside Out 2" } ],
            "Comedia": [ { id: "HRjq_rcXpD0", t: "Ghostbusters: Frozen Empire" }, { id: "hXZNV1A2m1I", t: "Beetlejuice Beetlejuice" } ],
            "Documentales": [ { id: "eTGEhP8z2nQ", t: "Planet Earth III" }, { id: "urRVZ4SW7WU", t: "Free Solo" } ]
        };

        window.loadYouTubeTrailers = async function() {
            const selectEl = document.getElementById('trailerCategory');
            const catName = selectEl.options[selectEl.selectedIndex].text;
            document.getElementById('trailer-section-title').innerText = "Tr√°ilers: " + catName;
            const container = document.getElementById('dynamic-trailers');
            
            container.innerHTML = '<p style="color:var(--primary); padding:10px;"><i data-lucide="loader" class="lucide-spin"></i> Buscando en YouTube...</p>';
            if(window.lucide) lucide.createIcons();

            let videos = [];
            
            try {
                // INTENTO 1: Buscar en YouTube en tiempo real a trav√©s del proxy
                const query = encodeURIComponent(`trailer oficial pelicula ${catName} 2026`);
                const res = await fetch(`https://corsproxy.io/?https://www.youtube.com/results?search_query=${query}`);
                
                if(!res.ok) throw new Error("Proxy bloqueado por YouTube");
                const html = await res.text();

                const regex = /"videoRenderer":\{"videoId":"([^"]+)".*?"title":\{"runs":\[\{"text":"([^"]+)"/g;
                let match;
                while ((match = regex.exec(html)) !== null && videos.length < 15) {
                    if(!videos.some(v => v.id === match[1])) {
                        videos.push({ id: match[1], t: match[2].replace(/\\u0026/g, '&').replace(/\\"/g, '"') });
                    }
                }
                
                if(videos.length === 0) throw new Error("Scraping fallido por cambios en YouTube");

            } catch(e) {
                // INTENTO 2 (FALLBACK INMORTAL): Si YouTube bloque√≥ el proxy, usamos la base de datos local
                console.log("Activando protocolo de respaldo anti-bloqueos...");
                videos = fallbackTrailers[catName] || fallbackTrailers["Acci√≥n y Adrenalina"];
                // Mezclamos los videos aleatoriamente para que siempre parezcan nuevos
                videos = videos.sort(() => 0.5 - Math.random());
            }

            // Renderizamos los videos (vengan de donde vengan)
            container.innerHTML = videos.map(v => {
                const isFav = trailerFavs.some(f => f.id === v.id) ? 'active' : '';
                return `<div class="trailer-card">
                    <button onclick="toggleTrailerFav('${v.id}', '${v.t.replace(/'/g, "\\'")}')" class="mini-btn fav ${isFav}" style="position:absolute; top:5px; right:5px; z-index:10;"><i data-lucide="heart" size="14"></i></button>
                    <a href="https://youtube.com/watch?v=${v.id}" target="_blank" style="text-decoration:none; color:white;">
                        <img src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg">
                        <div class="trailer-overlay"><i data-lucide="play-circle" size="32" style="color:var(--primary)"></i></div>
                        <div style="padding:8px; font-size:0.75rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${v.t}</div>
                    </a></div>`;
            }).join('');
            
            if(window.lucide) lucide.createIcons();
        };

        window.toggleTrailerFav = function(id, title) {
            const index = trailerFavs.findIndex(f => f.id === id);
            if(index > -1) trailerFavs.splice(index, 1); else trailerFavs.push({id, title});
            localStorage.setItem('vicomedia_tfavs', JSON.stringify(trailerFavs)); loadYouTubeTrailers(); renderFavorites();
        };

        // --- SISTEMA RSS EDITABLE ---
        function renderRssList() {
            const listDiv = document.getElementById('rss-list');
            listDiv.innerHTML = rssSources.map((url, i) => `
                <div style="display:flex; justify-content:space-between; align-items:center; background:#222; padding:8px; margin-bottom:5px; border-radius:4px; font-size:0.75rem;">
                    <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:80%;">${url}</span>
                    <button onclick="deleteRss(${i})" style="color:red; background:none; border:none; cursor:pointer;"><i data-lucide="trash" size="14"></i></button>
                </div>
            `).join('');
            if(window.lucide) lucide.createIcons();
        }

        window.addRss = function() {
            const val = document.getElementById('newRssUrl').value.trim();
            if(val && !rssSources.includes(val)) {
                rssSources.push(val);
                localStorage.setItem('vicomedia_rss', JSON.stringify(rssSources));
                document.getElementById('newRssUrl').value = '';
                renderRssList(); loadRSS();
            }
        };

        window.deleteRss = function(i) {
            rssSources.splice(i, 1);
            localStorage.setItem('vicomedia_rss', JSON.stringify(rssSources));
            renderRssList(); loadRSS();
        };

        window.loadRSS = async function() {
            const rssDiv = document.getElementById('rss-feed');
            rssDiv.innerHTML = "<p style='padding:10px;color:var(--primary)'>Descargando √∫ltimas noticias...</p>";
            let allItems = [];

            try {
                for(let url of rssSources) {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`);
                    const data = await res.json();
                    if(data.items) allItems = allItems.concat(data.items);
                }
                
                // Ordenar por fecha (las m√°s nuevas primero)
                allItems.sort((a,b) => new Date(b.pubDate) - new Date(a.pubDate));
                
                if(allItems.length > 0) {
                    rssDiv.innerHTML = allItems.slice(0, 15).map(i => `
                        <div class="rss-item">
                            <a href="${i.link}" target="_blank">üì∞ ${i.title}</a>
                            <div class="rss-date">${i.pubDate.split(' ')[0]}</div>
                        </div>
                    `).join('');
                } else {
                    rssDiv.innerHTML = "<p style='padding:10px;color:#666'>No hay noticias recientes.</p>";
                }
            } catch(e) { 
                rssDiv.innerHTML = "<p style='padding:10px;color:red'>Error cargando RSS. Revisa tus enlaces.</p>"; 
            }
        };

        function renderFavorites() {
            const grid = document.getElementById('fav-grid'); grid.innerHTML = '';
            library.filter(i => i.fav).forEach(item => grid.appendChild(createCard(item, library.indexOf(item))));
            const tGrid = document.getElementById('fav-trailers-grid'); tGrid.innerHTML = '';
            trailerFavs.forEach(v => {
                tGrid.innerHTML += `<div class="trailer-card" style="margin-bottom:10px;">
                    <button onclick="toggleTrailerFav('${v.id}', '')" class="mini-btn fav active" style="position:absolute; top:5px; right:5px; z-index:10;"><i data-lucide="trash" size="14"></i></button>
                    <a href="https://youtube.com/watch?v=${v.id}" target="_blank" style="text-decoration:none; color:white;">
                        <img src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg"><div style="padding:8px; font-size:0.75rem;">${v.title}</div>
                    </a></div>`;
            });
            lucide.createIcons();
        }

        window.playMedia = function(url, title, mode) {
            const modal = document.getElementById('playerModal'); document.getElementById('playerTitle').innerText = title;
            const wrap = document.getElementById('videoWrapper'); wrap.innerHTML = ''; 
            if(mode === 'iframe') {
                wrap.innerHTML = `<div class="ad-warning">üõ°Ô∏è Iframe Sandboxed</div><iframe src="${url}" sandbox="allow-scripts allow-same-origin allow-forms allow-presentation" allowfullscreen></iframe>`;
            } else if (mode === 'internal') {
                if(url.includes('youtube') || url.includes('youtu.be')) {
                    let vid = url.split('v=')[1] || url.split('/').pop(); if(vid.includes('&')) vid = vid.split('&')[0];
                    wrap.innerHTML = `<iframe src="https://www.youtube.com/embed/${vid}?autoplay=1" allowfullscreen></iframe>`;
                } else if(url.endsWith('.m3u8')) {
                    wrap.innerHTML = `<video id="hls-video" controls autoplay style="width:100%;height:100%"></video>`;
                    const video = document.getElementById('hls-video');
                    if (Hls.isSupported()) { const hls = new Hls(); hls.loadSource(url); hls.attachMedia(video); } 
                    else if (video.canPlayType('application/vnd.apple.mpegurl')) video.src = url;
                } else { wrap.innerHTML = `<video src="${url}" controls autoplay style="width:100%;height:100%"></video>`; }
            }
            modal.classList.remove('hidden');
        };
        window.closePlayer = function() { document.getElementById('videoWrapper').innerHTML = ''; document.getElementById('playerModal').classList.add('hidden'); };

        // --- DETECCI√ìN Y CHAT ---
        window.detectApiKey = function(key) {
            const prov = document.getElementById('apiProvider'), stat = document.getElementById('apiStatus');
            if(key.startsWith('AIza')) { prov.value = 'gemini'; stat.innerHTML = '<span style="color:var(--primary)">‚úÖ Gemini detectada.</span>'; }
            else if(key.startsWith('gsk_')) { prov.value = 'groq'; stat.innerHTML = '<span style="color:var(--primary)">‚úÖ Groq detectada.</span>'; }
            else if(key.startsWith('sk-')) { if(prov.value !== 'deepseek') prov.value = 'openai'; stat.innerHTML = '<span style="color:var(--primary)">‚úÖ OpenAI/DeepSeek detectada.</span>'; }
            else if(key.length > 5) stat.innerHTML = '<span style="color:#ff6b6b">‚ö†Ô∏è Formato desconocido.</span>';
            else stat.innerHTML = 'Pega tu clave para detectar.';
        };
        window.saveApiKey = function() {
            apiKey = document.getElementById('apiKey').value.trim(); apiProvider = document.getElementById('apiProvider').value;
            localStorage.setItem('vicomedia_apikey', apiKey); localStorage.setItem('vicomedia_provider', apiProvider); alert('Guardado');
        };
        
        window.sendChat = async function() {
            const inp = document.getElementById('chatInput'); const txt = inp.value; if(!txt) return;
            const box = document.getElementById('chatBox'); box.innerHTML += `<div class="chat-msg msg-user">${txt}</div>`;
            inp.value = ''; box.scrollTop = box.scrollHeight;
            if(!apiKey) { box.innerHTML += `<div class="chat-msg msg-error">‚ö†Ô∏è Falta la API Key.</div>`; return; }
            
            const loadingId = "load_" + Date.now();
            box.innerHTML += `<div class="chat-msg msg-ai" id="${loadingId}">Procesando con ${apiProvider.toUpperCase()}...</div>`;
            box.scrollTop = box.scrollHeight;

            try {
                let aiText = "";
                if(apiProvider === 'gemini') {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Eres experto en cine. " + txt }] }] })
                    });
                    const data = await res.json();
                    if(!res.ok) throw new Error(data.error?.message || "Error Gemini");
                    aiText = data.candidates[0].content.parts[0].text;
                } else {
                    let endpoint = "https://api.openai.com/v1/chat/completions", model = "gpt-4o-mini";
                    
                    if(apiProvider === 'groq') { 
                        endpoint = "https://corsproxy.io/?https://api.groq.com/openai/v1/chat/completions"; 
                        model = "llama-3.3-70b-versatile"; 
                    }
                    if(apiProvider === 'deepseek') { 
                        endpoint = "https://api.deepseek.com/chat/completions"; 
                        model = "deepseek-chat"; 
                    }

                    const res = await fetch(endpoint, {
                        method: "POST", headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ messages: [{ role: "system", content: "Eres experto en cine." }, { role: "user", content: txt }], model: model })
                    });
                    const data = await res.json();
                    if(!res.ok) throw new Error(data.error?.message || "CORS o Key inv√°lida.");
                    aiText = data.choices[0].message.content;
                }
                document.getElementById(loadingId).remove();
                box.innerHTML += `<div class="chat-msg msg-ai">VICO: ${aiText}</div>`;
            } catch(e) {
                document.getElementById(loadingId).remove();
                box.innerHTML += `<div class="chat-msg msg-error">‚ö†Ô∏è Error: ${e.message}</div>`;
            }
            box.scrollTop = box.scrollHeight;
        };

        window.toggleTheme = function() { document.body.classList.toggle('matrix-mode'); localStorage.setItem('vicomedia_theme', document.body.classList.contains('matrix-mode') ? 'matrix' : 'cyber'); };
        window.exportData = function() { const blob = new Blob([JSON.stringify({lib: library, favs: trailerFavs, cats: categories})], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "vico_backup.json"; a.click(); };
        window.importData = function(input) {
            const r = new FileReader(); r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result); if(d.lib) { library = d.lib; trailerFavs = d.favs || []; categories = d.cats || defaultCategories; } else { library = d; }
                    saveData(); localStorage.setItem('vicomedia_tfavs', JSON.stringify(trailerFavs)); localStorage.setItem('vicomedia_cats', JSON.stringify(categories));
                    alert('Restaurado'); renderCategories();
                } catch(err) { alert('Error JSON'); }
            }; if(input.files[0]) r.readAsText(input.files[0]);
        };
    </script>
</body>
        </html>
